<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT Global Infrastructure Dashboard</title>
    <!-- OT Dashboard (Azure DevOps, compact status, colorful map, robust coords) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<!-- MSAL.js for Microsoft authentication - removed due to CDN blocking -->




<script>
// Provide _spPageContextInfo early if Script Editor runs before SPO defines it
window._spPageContextInfo = window._spPageContextInfo || (function(){
  var m = location.pathname.match(/^\/(sites|teams)\/[^\/]+/);
  var rel = m ? m[0] : '';
  return { webAbsoluteUrl: location.origin + rel, webServerRelativeUrl: rel || '/' };
})();
</script>

<script>
(function(){
  try{
    var dbg = location.search.indexOf('debug=1')!==-1;
    if(!dbg) return; // only enable overlay when debug=1
    if(window.OTDiagInit) return; window.OTDiagInit=true;
    function initDiag(){
      try{
        var panel=document.createElement('div'); panel.id='otdiag_panel';
        panel.setAttribute('style','position:fixed;right:12px;bottom:48px;z-index:99999;width:420px;max-height:40vh;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px;font-family:ui-monospace,monospace;font-size:12px;display:none;white-space:pre-wrap');
        document.addEventListener('keydown', function(ev){ if(ev.key==='`' && ev.ctrlKey){ panel.style.display = (panel.style.display==='none'||!panel.style.display)? '' : 'none'; } });
        document.body.appendChild(panel);
        var logs=[];
        window.OTDiagLog=function(){ try{ var a=[].slice.call(arguments); var line=a.map(function(v){ try{ return (typeof v==='string')? v : JSON.stringify(v);}catch{return String(v)} }).join(' '); var ts=new Date().toISOString().substring(11,19); logs.push('['+ts+'] '+line); if(logs.length>1000) logs.shift(); panel.textContent=logs.slice(-500).join('\n'); }catch{} };
        window.addEventListener('error', function(e){ window.OTDiagLog('window.error', e.message, (e.filename||'')+':'+(e.lineno||'')+':'+(e.colno||'')); });
        window.addEventListener('unhandledrejection', function(e){ var r=e&&e.reason; window.OTDiagLog('unhandledrejection', (r&&(r.message||r))||String(r)); });
        try{
          var oe=console.error.bind(console), ow=console.warn.bind(console), ol=console.log.bind(console);
          console.error=function(){ window.OTDiagLog('console.error', arguments[0] instanceof Error? (arguments[0].stack||arguments[0].message): arguments[0], arguments[1]||''); oe.apply(console, arguments); };
          console.warn=function(){ window.OTDiagLog('console.warn', arguments[0]||''); ow.apply(console, arguments); };
          console.log=function(){ if(location.search.indexOf('debug=1')!==-1){ try{ window.OTDiagLog('console.log', arguments[0]||''); }catch{} } ol.apply(console, arguments); };
        }catch{}
        window.OTDiagGet=function(){ return logs.join('\n'); };
        window.OTDiagCopy=function(){ try{ navigator.clipboard.writeText(window.OTDiagGet()); window.OTDiagLog('copied to clipboard'); }catch{} };
        window.OTDiagLog('OT diagnostics overlay ready');
      }catch{}
    }
    if(document.body) initDiag(); else document.addEventListener('DOMContentLoaded', initDiag);
  }catch{}
})();
</script>

</head>
<body>

<div id="otapp" data-inited="0" data-theme="looker">
  <div class="brand">
    <img id="brandLogo" alt="Bunge" class="logo"/>
    <h1 style="color:#000">Global OT Infrastructure Improvements <span style="color:#F59E0B">(under development)</span></h1>
    <button id="themeToggle" class="theme-toggle" title="Toggle Dark Mode">
      <span class="theme-icon">🌙</span>
    </button>
  </div>


  <!-- Compact “friendly” status -->
  <div id="status" class="meta" style="margin:4px 0 10px 0"></div>

  <!-- Loading bar -->
  <div id="loader" class="loader" aria-live="polite">
    <div class="loader-row">
      <div id="loaderText" class="loader-text">Loading…</div>
      <div class="loader-bar"><span id="loaderFill" style="width:0%"></span></div>
    </div>
  </div>

  <!-- Azure DevOps Configuration -->
  <div class="filters">
    <button id="btnLoadDevOps" class="btn primary">Load from Azure DevOps</button>
  </div>

  <!-- Azure DevOps Configuration -->
  <div id="devOpsConfig" class="config-section">
    <h3>Azure DevOps Configuration</h3>
    <div class="config-grid">
      <div class="form-group">
        <label class="form-label" for="devOpsOrg">Organization:</label>
        <input type="text" id="devOpsOrg" class="form-input" 
               placeholder="BungeDev" value="BungeDev">
      </div>
      <div class="form-group">
        <label class="form-label" for="devOpsProject">Project:</label>
        <input type="text" id="devOpsProject" class="form-input" 
               placeholder="OT Global Infrastructure" value="OT Global Infrastructure">
      </div>
      <div class="form-group">
        <label class="form-label" for="devOpsToken">Personal Access Token:</label>
        <input type="password" id="devOpsToken" class="form-input" 
               placeholder="Enter your Azure DevOps PAT">
      </div>
      <div class="form-group">
        <label class="form-label" for="devOpsFields">Fields to Display:</label>
        <select id="devOpsFields" class="form-input" multiple size="6" style="height: 120px;">
          <option value="Site" selected>Site</option>
          <option value="TaskId" selected>Task ID</option>
          <option value="TaskName" selected>Task Name</option>
          <option value="TaskType" selected>Task Type</option>
          <option value="Status" selected>Status</option>
          <option value="PlannedDate" selected>Planned Date</option>
          <option value="CompletedDate" selected>Completed Date</option>
          <option value="Owner" selected>Owner</option>
          <option value="AreaPath" selected>Area Path</option>
          <option value="IterationPath" selected>Iteration Path</option>
          <option value="CreatedDate">Created Date</option>
          <option value="ChangedDate">Changed Date</option>
          <option value="Description">Description</option>
        </select>
        <small style="color: #666; font-size: 12px;">Hold Ctrl/Cmd to select multiple fields</small>
      </div>
      <div class="form-group">
        <label class="form-label" for="devOpsExcludePaths">Exclude Area Paths (comma-separated):</label>
        <input type="text" id="devOpsExcludePaths" class="form-input" 
               placeholder="BAU,Maintenance,Support" 
               value="BAU,BEA 2025 Continuous">
      </div>
      <div class="form-group">
        <label class="form-label" for="siteCoordinates">Site Coordinates (JSON):</label>
        <textarea id="siteCoordinates" class="form-input" rows="8" 
                  placeholder='{"Barcelona": {"lat": 41.35913, "lon": 2.1689, "name": "Barcelona, Spain"}, "Escombreras": {"lat": 37.56719, "lon": -0.95152, "name": "Escombreras, Spain"}}'>{"Barcelona": {"lat": 41.35913, "lon": 2.1689, "name": "Barcelona, Spain"}, "Escombreras": {"lat": 37.56719, "lon": -0.95152, "name": "Escombreras (Cartagena), Murcia, Spain"}, "Bilbao": {"lat": 43.26301, "lon": -2.93499, "name": "Bilbao / Zierbena (Bizkaia), Spain"}, "Bruck": {"lat": 48.0167, "lon": 16.7667, "name": "Bruck an der Leitha, Austria"}, "Mannheim": {"lat": 49.488888, "lon": 8.469167, "name": "Mannheim, Germany"}, "Izmir": {"lat": 38.423733, "lon": 27.142826, "name": "Izmir (Aliağa), Turkey"}, "ESC": {"lat": 37.56719, "lon": -0.95152, "name": "Escombreras (Cartagena), Murcia, Spain"}, "BIO": {"lat": 43.26301, "lon": -2.93499, "name": "Bilbao / Zierbena (Bizkaia), Spain"}, "BAR": {"lat": 41.35913, "lon": 2.1689, "name": "Barcelona, Spain"}, "BRU": {"lat": 48.0167, "lon": 16.7667, "name": "Bruck an der Leitha, Austria"}, "MAN": {"lat": 49.488888, "lon": 8.469167, "name": "Mannheim, Germany"}, "IZM": {"lat": 38.423733, "lon": 27.142826, "name": "Izmir (Aliağa), Turkey"}, "BSA": {"lat": -25.7479, "lon": 28.2293, "name": "South Africa (BSA)"}, "TAI": {"lat": 25.0330, "lon": 121.5654, "name": "Taiwan (TAI)"}, "BCN": {"lat": 41.35913, "lon": 2.1689, "name": "Barcelona, Spain"}}</textarea>
        <div style="margin-top: 8px; font-size: 12px; color: #666;">
          <strong>Debug:</strong> <span id="coordsDebug">Click "Load Data" to see coordinate matching</span>
        </div>
        <small style="color: #666; font-size: 12px;">Enter site coordinates as JSON. Format: {"SiteCode": {"lat": latitude, "lon": longitude, "name": "Location Name"}}</small>
      </div>
    </div>
  </div>


  <div class="filters">
    <select id="fBU" title="Business Unit"></select>
    <select id="fType" title="Project Type"></select>
    <select id="fYear" title="Year"></select>
    <select id="fStatus" title="Status"></select>
    <button id="btnExport" class="btn">Export CSV</button>
    <button id="btnDiag" class="btn primary">Diagnostics</button>
    <button id="btnCopyDiag" class="btn primary">Copy Logs</button>
  </div>

  <div id="err" class="err" style="display:none"></div>

  <div id="kpiProjects" class="kpi"></div>
  <div id="kpiInventory" class="kpi"></div>

  <h3 id="mapTitle">Sites map</h3>
  <div class="filters"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="toggleMap"/> Show map</label></div>
  <div id="map" class="map" style="display:none"></div>
  <div class="map-note" id="mapNote" style="display:none"></div>
  <div id="diag" class="diag" style="display:none"></div>

  <h3>Projects</h3>
  <div id="cards"></div>

  <h3>Tasks drill-down</h3>
  <div class="filters">
    <select id="sitePick" title="Site"></select>
    <select id="fTaskStatus" title="Task Status"></select>
  </div>
  <div id="taskStatus" class="kpi small"></div>
  <div id="tasks" class="table-wrap"></div>
</div>

<style>
/* Full page width styles */
* { box-sizing: border-box; }
html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
body { font-family: Inter, "Segoe UI", system-ui, Arial; background: #F8FAFC; }

:root{--text:#0F172A;--muted:#64748B;--border:#E2E8F0;--borderStrong:#CBD5E1;--bg:#F8FAFC;--surface:#FFFFFF;--kpi:#FFFFFF;--primary:#0EA5E9;--primary-600:#0284C7;--accent:#22C55E;--accent-600:#16A34A;--warn:#D97706;--danger:#DC2626;--green:#059669;--orange:#D97706;--gray:#64748B;--ring:rgba(14,165,233,.35)}
#otapp{max-width:none;width:100%;margin:0;padding:20px;box-sizing:border-box;font-family:Inter, "Segoe UI", system-ui, Arial;color:var(--text);background:var(--bg);min-height:100vh}
h1{margin:0 0 6px} h3{margin:14px 0 8px}
.brand{display:flex;align-items:flex-end;gap:16px;margin:12px 0 14px;background:linear-gradient(180deg, rgba(14,165,233,.06), rgba(34,197,94,.04));border:1px solid var(--border);border-radius:14px;padding:12px 14px}
.brand .logo{height:40px;margin-top:2px}
.brand h1{font-size:26px;font-weight:800;letter-spacing:.3px;line-height:1.1;padding-bottom:2px;margin-top:14px;position:relative;top:6px}
.filters{margin:8px 0;display:flex;gap:10px;flex-wrap:wrap;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:8px 10px}
select,.btn{height:36px;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);transition:box-shadow .15s ease, transform .05s ease, border-color .15s ease}
.btn{cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(248,250,252,.9))}
.btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(2,132,199,.08)}
select:focus,.btn:focus{outline:0;box-shadow:0 0 0 3px var(--ring);border-color:var(--primary)}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:10px 0}
.kpi .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;box-shadow:0 1px 2px rgba(2,6,23,.04);transition:box-shadow .2s ease, transform .12s ease, border-color .15s ease}
.kpi .card:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(2,6,23,.08);border-color:var(--borderStrong)}
.kpi .label{color:var(--muted);font-size:13px}
.kpi .value{font-size:26px;font-weight:700;margin-top:4px}
.kpi.small .value{font-size:22px}
.err{background:#FEE2E2;color:#991B1B;border:1px solid #FECACA;border-radius:8px;padding:10px;margin:8px 0}
.meta{color:var(--muted);font-size:12px}
.row{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(2,6,23,.04);transition:box-shadow .2s ease, transform .12s ease, border-color .15s ease}
.row:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(2,6,23,.09);border-color:var(--borderStrong)}
.top{display:flex;justify-content:space-between;gap:8px;margin-bottom:6px}
.pill{padding:2px 8px;border-radius:999px;color:#fff;font-size:12px;align-self:flex-start}
.done{background:var(--green)} .prog{background:var(--orange)} .other{background:var(--gray)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
.box{border:1px solid var(--border);border-radius:10px;padding:10px}
.box.before{background:#EEF2FF;border-left:4px solid #6366F1}
.box.after{background:#ECFDF5;border-left:4px solid #10B981}
.box.before b{color:#4F46E5}
.box.after b{color:#059669}
.bu{display:inline-flex;align-items:center;justify-content:center;height:22px;padding:0 10px;border-radius:999px;color:#fff;font-size:12px;font-weight:600;margin-left:8px;line-height:22px}
.bu-BEA{background:#2563EB}
.bu-BNA{background:#0EA5E9}
.bu-BSA{background:#10B981}
.kpi.bu-strip{grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px;margin-top:8px}
.kpi .card.bu{display:flex;align-items:center;justify-content:center;gap:8px;padding:6px 10px;border:none;color:#fff;border-radius:10px}
.kpi .card.bu .label{color:#fff;font-size:13px;font-weight:700}
.kpi .card.bu .value{font-size:18px;font-weight:800;margin:0}
.kpi .card.bu.BEA{background:#2563EB}
.kpi .card.bu.BNA{background:#0EA5E9}
.kpi .card.bu.BSA{background:#10B981}
.map{height:clamp(320px,48vh,560px);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.05);margin:8px 0;background:#fff}
.map-note{font-size:12px;color:var(--muted);margin:4px 2px}
.diag{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px; border:1px solid var(--border); border-radius:8px; background:#fff; padding:8px; margin:8px 0; max-height:240px; overflow:auto; white-space:pre-wrap}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px;max-height:clamp(260px,52vh,620px);-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;table-layout:fixed}
th,td{padding:10px;border-top:1px solid var(--border);text-align:left;font-size:14px;word-break:break-word}
thead th{position:sticky;top:0;background:#F1F5F9;color:#0F172A;z-index:1;box-shadow:inset 0 -1px 0 var(--borderStrong)}
tbody tr:nth-child(even){background:#F8FAFC}
tbody tr:hover{background:#EEF2FF}
.status-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600;color:#fff}
.status-planned{background:#6B7280}
.status-inprogress{background:#D97706}
.status-completed{background:#059669}
.status-blocked{background:#DC2626}
.status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
.status-dot.planned{background:#6B7280}
.status-dot.inprogress{background:#D97706}
.status-dot.completed{background:#059669}
.status-dot.blocked{background:#DC2626}
/* Friendly row highlighting by task status */
.task-row{transition:background .15s ease,border-color .15s ease; border-left:4px solid transparent}
.task-row.planned{background:#F3F4F6;border-left-color:#9CA3AF}
.task-row.inprogress{background:#EFF6FF;border-left-color:#3B82F6}
.task-row.completed{background:#ECFDF5;border-left-color:#10B981}
.task-row.blocked{background:#FEF2F2;border-left-color:#EF4444}

/* Dark theme adjustments for row highlighting */
[data-theme="dark"] .task-row.planned{background:rgba(156,163,175,.15);border-left-color:#9CA3AF}
[data-theme="dark"] .task-row.inprogress{background:rgba(59,130,246,.15);border-left-color:#60A5FA}
[data-theme="dark"] .task-row.completed{background:rgba(16,185,129,.15);border-left-color:#34D399}
[data-theme="dark"] .task-row.blocked{background:rgba(239,68,68,.15);border-left-color:#FCA5A5}
.loader{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin:8px 0;will-change:opacity,transform}
.loader-row{display:flex;gap:12px;align-items:center}
.loader-text{font-size:13px;color:#6B7280;min-width:200px}
.loader-bar{flex:1;height:8px;background:#F1F5F9;border-radius:999px;overflow:hidden;border:1px solid #E2E8F0}
.loader-bar span{display:block;height:100%;background:linear-gradient(90deg,#0EA5E9,#22C55E,#0EA5E9);background-size:200% 100%;border-radius:999px;transition:width .25s ease;animation:sheen 1.2s linear infinite}
.loader-bar span.complete{width:100% !important}
@keyframes fadeOut{to{opacity:0;transform:translateY(-4px);visibility:hidden}}
.loader.is-done{animation:fadeOut .35s ease forwards}
@media (prefers-reduced-motion: reduce){
  .btn,.row,.kpi .card,.loader-bar span{transition:none}
  .loader-bar span{animation:none}
}

/* Small-screen polish */
@media (max-width: 680px){
  .grid{grid-template-columns:1fr}
  .kpi{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  .row{padding:12px}
  .loader-text{min-width:auto;font-size:12px}
}

@keyframes sheen{0%{background-position:0% 0%}100%{background-position:200% 0%}}

/* Dark mode disabled by request (force light theme) */
</style>

<style>
/* Subtle custom scrollbars (supported browsers) */
.table-wrap::-webkit-scrollbar{height:10px;width:10px}
.table-wrap::-webkit-scrollbar-thumb{background:#CBD5E1;border-radius:999px}
.table-wrap::-webkit-scrollbar-track{background:#F1F5F9;border-radius:999px}

/* Pulsing beacon effect for active project markers */
@keyframes pulse-beacon {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.7; }
  100% { transform: scale(1); opacity: 1; }
}

.map-beacon {
  animation: pulse-beacon 2s ease-in-out infinite;
}
</style>

<style>
/* Looker-inspired theme (scoped) */
#otapp[data-theme="looker"]{
  --text:#1F2937; --muted:#6B7280; --bg:#F9FAFB; --surface:#FFFFFF; --kpi:#FFFFFF;
  --border:#E5E7EB; --borderStrong:#D1D5DB;
  --primary:#1A73E8; --primary-600:#1669C1;
  --accent:#9333EA; --accent-600:#7E22CE;
  --ring:rgba(26,115,232,.28);
}
#otapp[data-theme="looker"] .brand{background:#fff;border-color:var(--borderStrong)}
#otapp[data-theme="looker"] .btn{background:#fff;color:var(--primary);border-color:var(--borderStrong)}
#otapp[data-theme="looker"] .btn.primary{background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(249,250,251,.96));color:#fff;border-color:var(--primary);background-color:var(--primary)}
#otapp[data-theme="looker"] .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
#otapp[data-theme="looker"] .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(26,115,232,.10);border-color:var(--primary)}
#otapp[data-theme="looker"] .btn.primary:hover{box-shadow:0 8px 18px rgba(26,115,232,.18);filter:saturate(1.05)}
#otapp[data-theme="looker"] .kpi .card{box-shadow:none;border-color:var(--borderStrong)}
#otapp[data-theme="looker"] thead th{background:#F3F6FC;color:#111827;box-shadow:inset 0 -1px 0 var(--borderStrong)}
#otapp[data-theme="looker"] tbody tr:hover{background:#EFF6FF}
#otapp[data-theme="looker"] .row:hover{box-shadow:0 8px 24px rgba(17,24,39,.08)}
#otapp[data-theme="looker"] .pill.done{background:#22C55E}
#otapp[data-theme="looker"] .pill.prog{background:#F59E0B}
#otapp[data-theme="looker"] .pill.other{background:#6B7280}
#otapp[data-theme="looker"] .status-dot.inprogress{background:#F59E0B}
#otapp[data-theme="looker"] .status-dot.completed{background:#22C55E}
#otapp[data-theme="looker"] .status-dot.planned{background:#9CA3AF}
#otapp[data-theme="looker"] .status-dot.blocked{background:#EF4444}
#otapp[data-theme="looker"] .loader-bar{border-color:#D1E3FF;background:#E9F2FF}
#otapp[data-theme="looker"] .loader-bar span{background:linear-gradient(90deg,#1A73E8,#9333EA,#1A73E8)}
#otapp[data-theme="looker"] .filters{border-color:var(--borderStrong)}
</style>

<!-- Additional styles for Azure DevOps configuration -->
<style>
.config-section {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.config-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-label {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
  font-size: 14px;
}

.form-input {
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.2s;
}

.form-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--ring);
}

.status {
  padding: 12px 16px;
  border-radius: 8px;
  margin: 16px 0;
  font-size: 14px;
  font-weight: 500;
}

.status.success {
  background: #d1fae5;
  border: 1px solid #a7f3d0;
  color: #065f46;
}

.status.error {
  background: #fee2e2;
  border: 1px solid #fecaca;
  color: #991b1b;
}

.status.info {
  background: #e0f2fe;
  border: 1px solid #81d4fa;
  color: #0277bd;
}

/* Dark Mode Styles */
[data-theme="dark"] {
  --text: #E2E8F0;
  --muted: #94A3B8;
  --border: #334155;
  --borderStrong: #475569;
  --bg: #0F172A;
  --surface: #1E293B;
  --kpi: #1E293B;
  --primary: #3B82F6;
  --primary-600: #2563EB;
  --accent: #10B981;
  --accent-600: #059669;
  --warn: #F59E0B;
  --danger: #EF4444;
  --green: #10B981;
  --orange: #F59E0B;
  --gray: #64748B;
  --ring: rgba(59, 130, 246, 0.35);
}

/* Apply dark theme to the main app container */
[data-theme="dark"] #otapp {
  background: var(--bg) !important;
  color: var(--text) !important;
}

[data-theme="dark"] body {
  background: var(--bg) !important;
  color: var(--text) !important;
}

[data-theme="dark"] html {
  background: var(--bg) !important;
}

[data-theme="dark"] .brand {
  background: linear-gradient(180deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.08));
  border-color: var(--border);
}

[data-theme="dark"] .brand h1 {
  color: var(--text) !important;
}

[data-theme="dark"] .brand h1 span {
  color: #F59E0B !important;
}

[data-theme="dark"] .theme-toggle {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
}

[data-theme="dark"] .theme-toggle:hover {
  background: var(--primary);
  color: white;
}

[data-theme="dark"] .form-input {
  background: var(--surface);
  border-color: var(--border);
  color: var(--text);
}

[data-theme="dark"] .form-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--ring);
}

[data-theme="dark"] .status.success {
  background: #064e3b;
  border-color: #065f46;
  color: #6ee7b7;
}

[data-theme="dark"] .status.error {
  background: #7f1d1d;
  border-color: #991b1b;
  color: #fca5a5;
}

[data-theme="dark"] .status.info {
  background: #1e3a8a;
  border-color: #1d4ed8;
  color: #93c5fd;
}

[data-theme="dark"] .config-section {
  background: var(--surface);
  border-color: var(--border);
}

[data-theme="dark"] .card {
  background: var(--surface);
  border-color: var(--border);
}

[data-theme="dark"] .card .label {
  color: var(--muted);
}

[data-theme="dark"] .card .value {
  color: var(--text);
}

[data-theme="dark"] .filters {
  background: var(--surface);
  border-color: var(--border);
}

[data-theme="dark"] select {
  background: var(--surface);
  border-color: var(--border);
  color: var(--text);
}

[data-theme="dark"] .btn {
  background: var(--surface);
  border-color: var(--border);
  color: var(--text);
}

[data-theme="dark"] .btn:hover {
  background: var(--primary);
  color: white;
}

[data-theme="dark"] .btn.primary {
  background: var(--primary);
  color: white;
}

[data-theme="dark"] .btn.primary:hover {
  background: var(--primary-600);
}

[data-theme="dark"] .table-wrap {
  background: var(--surface);
  border-color: var(--border);
}

[data-theme="dark"] .table-wrap th {
  background: var(--bg);
  color: var(--text);
  border-color: var(--border);
}

[data-theme="dark"] .table-wrap td {
  border-color: var(--border);
  color: var(--text);
}

[data-theme="dark"] .kpi {
  background: var(--surface);
  border-color: var(--border);
}

[data-theme="dark"] .meta {
  color: var(--muted);
}

[data-theme="dark"] .err {
  background: #7f1d1d;
  border-color: #991b1b;
  color: #fca5a5;
}

[data-theme="dark"] h1, 
[data-theme="dark"] h2, 
[data-theme="dark"] h3, 
[data-theme="dark"] h4, 
[data-theme="dark"] h5, 
[data-theme="dark"] h6 {
  color: var(--text) !important;
}

[data-theme="dark"] .loader {
  background: var(--surface);
  border-color: var(--border);
}

[data-theme="dark"] .loader-text {
  color: var(--text);
}

[data-theme="dark"] .loader-bar {
  background: var(--border);
  border-color: var(--borderStrong);
}

[data-theme="dark"] .loader-bar span {
  background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
}

[data-theme="dark"] .meta {
  color: var(--muted);
}

[data-theme="dark"] .helpMessage {
  background: var(--surface);
  border-color: var(--border);
  color: var(--text);
}

[data-theme="dark"] .helpMessage strong {
  color: var(--text);
}

[data-theme="dark"] .helpMessage a {
  color: var(--primary);
}

[data-theme="dark"] .helpMessage a:hover {
  color: var(--primary-600);
}

[data-theme="dark"] .box.before {
  background: rgba(99, 102, 241, 0.1);
  border-left-color: #6366F1;
}

[data-theme="dark"] .box.after {
  background: rgba(16, 185, 129, 0.1);
  border-left-color: #10B981;
}

[data-theme="dark"] .box.before b {
  color: #818CF8;
}

[data-theme="dark"] .box.after b {
  color: #34D399;
}

[data-theme="dark"] tbody tr:nth-child(even) {
  background: rgba(30, 41, 59, 0.3);
}

[data-theme="dark"] tbody tr:hover {
  background: rgba(59, 130, 246, 0.08) !important;
  color: var(--text) !important;
}

[data-theme="dark"] tbody tr:hover td {
  color: var(--text) !important;
  background: transparent !important;
}

/* Theme Toggle Button */
.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 48px;
  height: 48px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.theme-toggle:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
  border-color: var(--primary);
}

.theme-toggle:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.theme-icon {
  font-size: 18px;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.theme-toggle:hover .theme-icon {
  transform: rotate(15deg) scale(1.1);
}

[data-theme="dark"] .theme-toggle {
  background: linear-gradient(135deg, var(--surface) 0%, rgba(14, 165, 233, 0.1) 100%);
  border-color: rgba(14, 165, 233, 0.3);
}

[data-theme="light"] .theme-toggle {
  background: linear-gradient(135deg, var(--surface) 0%, rgba(251, 191, 36, 0.1) 100%);
  border-color: rgba(251, 191, 36, 0.3);
}
</style>

<script>
(async()=>{
  logDiag('OT init start');
  // Prevent double init if SP re-renders the web part
  const root = document.getElementById('otapp');
  if(!root || root.dataset.inited === '1'){ return; }
  root.dataset.inited = '1';

  const siteUrl=_spPageContextInfo.webAbsoluteUrl;
  const urlParams = new URLSearchParams(location.search);
  const VERBOSE = urlParams.get('debug') === '1'; // quiet by default
  
  const IS_DEV = (function(){
    try{
      if(urlParams.get('dev')==='1') return true;
      if(location.protocol==='file:') return true;
      const h=(location.hostname||'').toLowerCase();
      if(h==='localhost' || h==='127.0.0.1') return true;
      if(!/(sharepoint|microsoftonline|office)/i.test(h)) return true;
    }catch{}
    return false;
  })();

  const showErr=m=>{const e=document.getElementById("err");e.style.display="";e.textContent=m};
  const statusEl=document.getElementById('status');
  const diagEl=document.getElementById('diag');
  const btnDiag=document.getElementById('btnDiag');
  const btnCopyDiag=document.getElementById('btnCopyDiag');
  const diagLogs=[]; window.OTDiagBuffer = diagLogs;
  function logDiag(...args){
    try{
      const line = args.map(v=>{ try{ if(typeof v==='string') return v; return JSON.stringify(v); }catch{return String(v)} }).join(' ');
      const ts = new Date().toISOString().substring(11,19);
      diagLogs.push(`[${ts}] ${line}`);
      if(diagEl){ diagEl.textContent = diagLogs.slice(-500).join('\n'); }
      try{ if(typeof window.OTDiagLog==='function'){ window.OTDiagLog.apply(null, args); } }catch{}
      if(VERBOSE) console.log('[OT-DIAG]', ...args);
    }catch{}
  }
  try{
    window.addEventListener('error', (e)=>{ logDiag('window.error', {msg:e.message, src:e.filename, line:e.lineno, col:e.colno}); });
    window.addEventListener('unhandledrejection', (e)=>{ logDiag('unhandledrejection', {reason: (e.reason && (e.reason.message||e.reason)) || String(e.reason)}); });
    const origErr=console.error.bind(console), origWarn=console.warn.bind(console), origLog=console.log.bind(console);
    console.error=(...a)=>{ logDiag('console.error', ...a); origErr(...a); };
    console.warn=(...a)=>{ logDiag('console.warn', ...a); origWarn(...a); };
    console.log=(...a)=>{ if(VERBOSE) logDiag('console.log', ...a); origLog(...a); };
  }catch{}
  
  // Helper function for populating dropdowns
  function fill(el, arr, lbl){
    return el.innerHTML=`<option value="">All ${lbl||""}</option>`+arr.map(v=>`<option>${v}</option>`).join("");
  }
  
  // Hide diagnostics controls in normal mode (only show when debug=1)
  try{ if(location.search.indexOf('debug=1')===-1){ if(btnDiag) btnDiag.style.display='none'; if(btnCopyDiag) btnCopyDiag.style.display='none'; if(diagEl) diagEl.style.display='none'; } }catch{}
  if(btnDiag){ btnDiag.onclick=()=>{ const v=diagEl.style.display!==''; diagEl.style.display=v?'':'none'; btnDiag.textContent = v? 'Hide Diagnostics':'Diagnostics'; }; }
  if(btnCopyDiag){ btnCopyDiag.onclick=()=>{ try{ navigator.clipboard.writeText(diagLogs.join('\n')); btnCopyDiag.textContent='Copied'; setTimeout(()=>btnCopyDiag.textContent='Copy Logs',1200);}catch{} } }

  // Loader UI
  const loaderEl=document.getElementById('loader');
  const loaderText=document.getElementById('loaderText');
  const loaderFill=document.getElementById('loaderFill');
  const steps=["Starting","Loading Excel engine","Finding files","Projects","Tasks","Sites","Rendering"];
  let stepIdx=0;
  function setLoader(text){ if(text) loaderText.textContent=text; loaderFill.style.width=Math.round((stepIdx/steps.length)*100)+"%"; }
  function next(text){ stepIdx=Math.min(stepIdx+1,steps.length); setLoader(text || steps[stepIdx]+'…'); }
  function hideLoader(){
    try{
      loaderFill.classList.add('complete');
      loaderFill.style.width='100%';
      loaderEl.classList.add('is-done');
      setTimeout(()=>{ loaderEl.style.display='none'; }, 380);
    }catch{ loaderEl.style.display='none'; }
  }
  const debugLog=[]; const note=(m)=>{ if(VERBOSE){ debugLog.push(m); console.debug(m); } logDiag(String(m)); };

  try{
    const wp = root.closest('[data-automation-id="CanvasControl"], .ControlZone');
    if(wp){
      wp.style.marginLeft='calc(50% - 50vw)'; wp.style.marginRight='calc(50% - 50vw)'; wp.style.width='100vw';
      const zone = wp.closest('[data-automation-id="CanvasZone"], .CanvasZone');
      if(zone){ zone.style.maxWidth='none'; zone.style.paddingLeft='0'; zone.style.paddingRight='0'; }
    }
  }catch{}

  // === CONFIG (Excel only) ===
  const FILE_PATHS = {
    projects: '/sites/GlobalOTInfrastructure/SiteAssets/ot/projects.xlsx',
    tasks:    '/sites/GlobalOTInfrastructure/SiteAssets/ot/tasks.xlsx',
    sites:    '/sites/GlobalOTInfrastructure/SiteAssets/ot/sites_inventory.xlsx'
  };

  // Logo
  try{
    const logoEl = document.getElementById('brandLogo');
    const base = siteUrl.replace(/\/$/, '');
    const candidates = (IS_DEV
      ? [
          'logo_netbox_dark_teal.svg',
          './logo_netbox_dark_teal.svg',
          'logo_netbox_dark_teal.png',
          './logo_netbox_dark_teal.png'
        ]
      : [
          base + '/SiteAssets/ot/logo_netbox_dark_teal.svg',
          base + '/SiteAssets/logo_netbox_dark_teal.svg',
          base + '/SiteAssets/ot/logo_netbox_dark_teal.png',
          base + '/SiteAssets/logo_netbox_dark_teal.png',
          base + '/SiteAssets/ot/bungelogo.png',
          base + '/SiteAssets/bungelogo.png'
        ]);
    (function nextLogo(i){
      if(i>=candidates.length) return;
      const img=new Image();
      img.onload=()=>{ logoEl.src=candidates[i]; };
      img.onerror=()=>nextLogo(i+1);
      img.src=candidates[i];
    })(0);
  }catch{}

  let PROJECTS=[],TASKS=[],SITES=[], siteCodes=[];



  const uniq=a=>[...new Set(a.filter(v=>v!==null&&v!==undefined&&v!==""))];

  // getBU — single definition
  const getBU = (r)=>{
    const bu = String(r.BusinessUnit||r.BU||'').trim().toUpperCase();
    if(bu==='BEA'||bu==='BNA'||bu==='BSA') return bu;
    const regRaw = String(r.Region||'').trim();
    const regU = regRaw.toUpperCase();
    const reg = regRaw.toLowerCase();
    if(regU==='BEA'||regU==='BNA'||regU==='BSA') return regU;
    if(reg.includes('europe')||reg.includes('asia')||reg.includes('emea')||reg.includes('apac')) return 'BEA';
    if(reg.includes('north')) return 'BNA';
    if(reg.includes('south')) return 'BSA';
    if(reg.includes('latam')||reg.includes('latin')) return 'BSA';
    if(reg==='na'||reg==='n.a.'||reg==='north america') return 'BNA';
    if(reg==='sa'||reg==='s.a.'||reg==='south america') return 'BSA';
    return 'Other';
  };

  // Helper function to check if area path should be excluded
  const shouldExcludeItem = (areaPath) => {
    if (!areaPath) return false;
    const excludePaths = document.getElementById('devOpsExcludePaths')?.value?.split(',').map(p => p.trim()).filter(Boolean) || ['BAU', 'BEA 2025 Continuous'];
    const areaPathLower = areaPath.toLowerCase();
    return excludePaths.some(excludePath => areaPathLower.includes(excludePath.toLowerCase()));
  };

  function toBool(v){
    if(v===true || v===1) return true;
    if(v===false || v===0 || v===null || v===undefined) return false;
    if(typeof v==='number') return v!==0;
    if(typeof v==='string'){
      const s=v.trim().toLowerCase();
      if(s==='') return false;
      if(s==='1'||s==='y'||s==='yes'||s==='true'||s==='t'||s==='x'||s==='on'||s==='enabled') return true;
      if(s==='0'||s==='n'||s==='no'||s==='false'||s==='f'||s==='off'||s==='disabled') return false;
      const n = Number(s); if(!isNaN(n)) return n!==0;
      return false;
    }
    return false;
  }

  // Parse coords: supports "12.34", "12,34", "12°34'56\"N", and swaps if needed
  function parseDMS(s){
    const str = String(s||'').trim().toUpperCase().replace(',', '.');
    const m = str.match(/(-?\d+(?:\.\d+)?)|(\d+)[°\s]+(\d+)[′']?[\s]*(\d+(?:\.\d+)?)[″"]?[\s]*([NSEW])?/g);
    if(!m) return NaN;
    // If simple number
    if(/^-?\d+(\.\d+)?$/.test(str)) return parseFloat(str);
    // DMS with optional hemisphere
    const d = /(\d+)[°\s]+(\d+)[′']?[\s]*(\d+(?:\.\d+)?)[″"]?[\s]*([NSEW])?/.exec(str);
    if(!d) return NaN;
    let deg=+d[1], min=+d[2], sec=parseFloat(d[3]||0), hemi=d[4]||'';
    let val = deg + (min/60) + (sec/3600);
    if(hemi==='S' || hemi==='W') val = -val;
    return val;
  }
  function parseCoord(v){
    if(v==null) return NaN;
    if(typeof v==='number') return v;
    const s=String(v).trim();
    if(!s) return NaN;
    // “lat,lon” in one cell
    if(s.includes(';')||s.includes(',')){
      const sep = s.includes(';')?';':',';
      const parts = s.split(sep).map(x=>x.trim());
      if(parts.length===2){
        const a=parseCoord(parts[0]), b=parseCoord(parts[1]);
        if(!isNaN(a) && isNaN(b)) return a;
        if(!isNaN(b) && isNaN(a)) return b;
      }
    }
    // Try DMS then float
    const d = parseDMS(s);
    if(!isNaN(d)) return d;
    const f = parseFloat(s.replace(',', '.'));
    return isNaN(f)? NaN : f;
  }
  function fixLatLon(lat, lon){
    let la=parseCoord(lat), lo=parseCoord(lon);
    // Swap if obviously flipped
    if((Math.abs(la)>90 && Math.abs(lo)<=90) || (Math.abs(lo)<-180 || Math.abs(lo)>180)){ const t=la; la=lo; lo=t; }
    // Clamp invalids
    if(Math.abs(la)>90) la = NaN;
    if(Math.abs(lo)>180) lo = NaN;
    return {lat:la, lon:lo};
  }

  function normalizeTaskRow(row){
    const statuses=["planned","in progress","completed","blocked"];
    if(!row.Status && typeof row.PlannedDate==='string' && statuses.includes(row.PlannedDate.trim().toLowerCase())){ row.Status = row.PlannedDate; row.PlannedDate = ''; }
    if(typeof row.Owner==='string' && /^\s*\d{4}\s*$/.test(row.Owner)){ row.Year = Number(row.Owner.trim()); row.Owner=''; }
    const tid=(row.TaskId||'').toString();
    if(!tid || /\s/.test(tid)){ const base=(row.TaskType||row.Project||'TASK'); row.TaskId = (base.substring(0,3).toUpperCase()||'TSK') + '-' + Math.random().toString(36).slice(2,6).toUpperCase(); }
    return row;
  }

  // Simple CSV parser that handles quoted fields and commas within quotes
  function parseCSVLine(line){
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (inQuotes && line[i+1] === '"') { // Escaped quote
          current += '"';
          i++; // skip next quote
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += ch;
      }
    }
    result.push(current);
    return result;
  }

  // ===== CSV Loader for Site Inventory =====
  async function loadSiteInventoryCSV() {
    try {
      // Try hyphenated name first, then underscore variant
      let response = await fetch('sites-inventory.csv');
      if (!response.ok) {
        logDiag('sites-inventory.csv not found, trying sites_inventory.csv');
        response = await fetch('sites_inventory.csv');
      }
      if (!response.ok) {
        logDiag('Site inventory CSV not found in either naming convention, skipping inventory data');
        return null;
      }
      const csvText = await response.text();
      const lines = csvText.split(/\r?\n/).filter(line => line.trim());
      if (lines.length < 2) return null;
      
      // Parse headers
      const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, '').toLowerCase());
      console.log('🔍 CSV Headers:', headers);
      const inventory = {};
      
      // Parse data rows
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]).map(v => v.trim().replace(/^"|"$/g, ''));
        if (values.length < headers.length) {
          console.log(`⚠️ Row ${i} skipped: not enough columns`, {valuesCount: values.length, headersCount: headers.length});
          continue;
        }
        
        const row = {};
        headers.forEach((header, idx) => {
          row[header] = values[idx];
        });
        
        
        // Extract site code
        const site = (row.sitecode || row.site || '').toString().trim();
        if (!site) continue;
        
        // Parse coordinates if available
        let lat = null, lon = null;
        if (row.latitude && !isNaN(parseFloat(row.latitude))) {
          lat = parseFloat(row.latitude);
        }
        if (row.longitude && !isNaN(parseFloat(row.longitude))) {
          lon = parseFloat(row.longitude);
        }
        
        const parseBool = (val) => {
          if (!val || val === '') return false;
          const str = String(val).toLowerCase().trim();
          return str === 'true' || str === '1' || str === 'yes' || str === 'y';
        };
        
        const siteData = {
          site: site.toUpperCase(),
          region: row.region || '',
          bu: row.bu || '',
          country: row.country || '',
          latitude: lat,
          longitude: lon,
          usesNewOTNetwork: parseBool(row.usesnewotnetworkip),
          monitoredSolarWinds: parseBool(row.monitoredsolarwindsot),
          monitoredSinecNMS: parseBool(row.monitoredsinecnmsot),
          inOTvSphere: parseBool(row.inotvsphere),
          localOTDomainController: parseBool(row.localotdomaincontroller),
          otSubnetCID: parseBool(row.otsubnetcid)
        };
        
        inventory[site.toUpperCase()] = siteData;
      }
      
      logDiag('Site inventory loaded from CSV', {sites: Object.keys(inventory).length});
      return inventory;
    } catch (error) {
      logDiag('Error loading site inventory CSV:', error);
      return null;
    }
  }

  // ===== Azure DevOps Integration Functions =====
  async function loadDataFromDevOps() {
    try {
      console.log('🔍 [LOAD] Starting loadDataFromDevOps');
      
      const org = document.getElementById('devOpsOrg')?.value || '';
      const project = document.getElementById('devOpsProject')?.value || '';
      const token = document.getElementById('devOpsToken')?.value || '';
      
      console.log('🔍 [LOAD] Form values:', {org, project, tokenLength: token.length || 0});
      
      if (!org || !project || !token) {
        const err = `Please fill in Organization, Project, and Personal Access Token. Current values: org=${org || 'empty'}, project=${project || 'empty'}, token=${token ? 'provided' : 'empty'}`;
        console.error('❌ [LOAD]', err);
        throw new Error(err);
      }
      
      next("Loading Azure DevOps data…");
      logDiag('Loading data from Azure DevOps', {org, project, query: 'all work items'});
      
      console.log('🔍 [LOAD] Calling getDevOpsWorkItems...');
      // Get work items from Azure DevOps
      const workItems = await getDevOpsWorkItems(org, project, token);
      console.log('✅ [LOAD] Received', workItems.length, 'work items from API');
      
      // Store original work items for region filtering
      window.originalWorkItems = workItems;
      console.log('🔍 [LOAD] Stored', workItems.length, 'original work items');
      
      // Get exclude paths configuration
      const excludePaths = document.getElementById('devOpsExcludePaths')?.value?.split(',').map(p => p.trim()).filter(Boolean) || ['BAU', 'BEA 2025 Continuous'];
      console.log('🔍 [LOAD] Exclude paths:', excludePaths);
      
      // Process work items into our data structure
      const excludedProjects = workItems.filter(item => 
        ['Project', 'Program', 'Epic'].includes(item.fields['System.WorkItemType']) &&
        shouldExcludeItem(item.fields['System.AreaPath'])
      );
      
      if (excludedProjects.length > 0) {
        logDiag('Excluded projects due to area path filtering:', excludedProjects.map(p => ({
          id: p.id,
          title: p.fields['System.Title'],
          areaPath: p.fields['System.AreaPath']
        })));
      }
      
      PROJECTS = workItems.filter(item => {
        const isProjectType = ['Project', 'Epic'].includes(item.fields['System.WorkItemType']);
        const isNotExcluded = !shouldExcludeItem(item.fields['System.AreaPath']);
        const title = item.fields['System.Title'] || '';
        const areaPath = item.fields['System.AreaPath'] || '';
        
        // Debug specific project
        if (title.toLowerCase().includes('gsp') || areaPath.toLowerCase().includes('gsp')) {
          logDiag(`GSP Project Debug:`, {
            title: title,
            workItemType: item.fields['System.WorkItemType'],
            areaPath: areaPath,
            isProjectType: isProjectType,
            isNotExcluded: isNotExcluded,
            shouldExclude: shouldExcludeItem(areaPath)
          });
        }
        
        return isProjectType && isNotExcluded;
      }).map(item => ({
        id: item.id,
        Project: item.fields['System.Title'],
        Status: item.fields['System.State'],
        Owner: item.fields['System.AssignedTo']?.displayName || '',
        Region: item.fields['Custom.Region'] || '',
        Site: item.fields['Custom.SiteCode'] || '',
        ProjectType: item.fields['System.WorkItemType'],
        Description: item.fields['System.Description'] || '',
        AreaPath: item.fields['System.AreaPath'] || '',
        IterationPath: item.fields['System.IterationPath'] || '',
        CreatedDate: item.fields['System.CreatedDate'],
        ChangedDate: item.fields['System.ChangedDate'],
        BusinessUnit: extractBusinessUnit(item.fields['System.AreaPath'] || ''),
        Year: extractYear(item.fields['System.IterationPath'] || ''),
        Latitude: null, // Not available in DevOps
        Longitude: null // Not available in DevOps
      }));
      
      const excludedTasks = workItems.filter(item => 
        ['Task', 'Bug', 'Issue', 'Requirement', 'Change Request', 'Enhancement'].includes(item.fields['System.WorkItemType']) &&
        shouldExcludeItem(item.fields['System.AreaPath'])
      );
      
      if (excludedTasks.length > 0) {
        logDiag('Excluded tasks due to area path filtering:', excludedTasks.map(t => ({
          id: t.id,
          title: t.fields['System.Title'],
          areaPath: t.fields['System.AreaPath']
        })));
      }
      
      TASKS = workItems.filter(item => 
        ['Task', 'Bug', 'Issue', 'Requirement', 'Change Request', 'Enhancement'].includes(item.fields['System.WorkItemType']) &&
        !shouldExcludeItem(item.fields['System.AreaPath'])
      ).map(item => ({
        id: item.id,
        TaskId: item.id.toString(),
        TaskName: item.fields['System.Title'],
        Status: item.fields['System.State'],
        Owner: item.fields['System.AssignedTo']?.displayName || '',
        Region: item.fields['Custom.Region'] || '',
        Site: item.fields['Custom.SiteCode'] || '',
        TaskType: item.fields['System.WorkItemType'],
        Description: item.fields['System.Description'] || '',
        AreaPath: item.fields['System.AreaPath'] || '',
        IterationPath: item.fields['System.IterationPath'] || '',
        CreatedDate: item.fields['System.CreatedDate'],
        ChangedDate: item.fields['System.ChangedDate'],
        PlannedDate: item.fields['Microsoft.VSTS.Scheduling.StartDate'],
        CompletedDate: item.fields['Microsoft.VSTS.Common.ClosedDate'],
        BusinessUnit: extractBusinessUnit(item.fields['System.AreaPath'] || ''),
        Year: extractYear(item.fields['System.IterationPath'] || '')
      })).map(normalizeTaskRow);
      
      // Load site coordinates from configuration
      let siteCoordinates = {};
      try {
        const coordsText = document.getElementById('siteCoordinates')?.value?.trim();
        logDiag('Raw site coordinates text:', coordsText);
        if (coordsText) {
          siteCoordinates = JSON.parse(coordsText);
          logDiag('Parsed site coordinates:', siteCoordinates);
          logDiag('Site coordinates keys:', Object.keys(siteCoordinates));
        } else {
          logDiag('No site coordinates text found in textarea');
        }
      } catch (error) {
        logDiag('Error parsing site coordinates:', error);
      }
      
      // Helper function to find coordinates for a site code
      const findSiteCoordinates = (siteCode) => {
        if (!siteCode) {
          logDiag('findSiteCoordinates: No site code provided');
          return null;
        }
        
        logDiag(`findSiteCoordinates: Looking for site code "${siteCode}"`);
        logDiag('Available site coordinate keys:', Object.keys(siteCoordinates));
        
        // Try exact match first
        if (siteCoordinates[siteCode]) {
          logDiag(`findSiteCoordinates: Exact match found for "${siteCode}":`, siteCoordinates[siteCode]);
          return siteCoordinates[siteCode];
        }
        
        // Try case-insensitive match
        const lowerSiteCode = siteCode.toLowerCase();
        for (const [key, coords] of Object.entries(siteCoordinates)) {
          if (key.toLowerCase() === lowerSiteCode) {
            logDiag(`findSiteCoordinates: Case-insensitive match found for "${siteCode}" -> "${key}":`, coords);
            return coords;
          }
        }
        
        // Try partial match (e.g., "Barcelona" matches "Barcelona, Spain")
        for (const [key, coords] of Object.entries(siteCoordinates)) {
          const lowerKey = key.toLowerCase();
          // Check if site code is contained in the key or vice versa
          if (lowerKey.includes(lowerSiteCode) || lowerSiteCode.includes(lowerKey)) {
            logDiag(`findSiteCoordinates: Partial match found for "${siteCode}" -> "${key}":`, coords);
            return coords;
          }
          // Also try matching the first word of the key (e.g., "Barcelona" matches "Barcelona, Spain")
          const firstWord = lowerKey.split(/[,\s]+/)[0];
          if (firstWord === lowerSiteCode || lowerSiteCode === firstWord) {
            logDiag(`findSiteCoordinates: First word match found for "${siteCode}" -> "${key}":`, coords);
            return coords;
          }
        }
        
        logDiag(`findSiteCoordinates: No match found for "${siteCode}"`);
        return null;
      };

      // Load site inventory from CSV (if available)
      const inventory = await loadSiteInventoryCSV();
      
      // For sites, we'll create a summary from the work items
      SITES = [];
      const allSiteCodes = workItems.map(item => item.fields['Custom.SiteCode']).filter(Boolean);
      logDiag('All site codes from Azure DevOps work items:', allSiteCodes);
      siteCodes = [...new Set(allSiteCodes)]
        .filter(code => !['BEA', 'BNA', 'BSA'].includes(code.toUpperCase()));
      logDiag('Extracted site codes from Azure DevOps (excluding BEA/BNA/BSA):', siteCodes);
      siteCodes.forEach(siteCode => {
        const siteItems = workItems.filter(item => item.fields['Custom.SiteCode'] === siteCode);
        const coords = findSiteCoordinates(siteCode);
        const invData = inventory ? inventory[siteCode.toUpperCase()] : null;
        logDiag(`Site: ${siteCode}, Found coordinates:`, coords, 'Inventory data:', invData);
        SITES.push({
          Site: siteCode,
          Region: invData?.region || siteItems[0]?.fields['Custom.Region'] || '',
          BusinessUnit: invData?.bu || extractBusinessUnit(siteItems[0]?.fields['System.AreaPath'] || ''),
          ProjectCount: siteItems.filter(item => ['Project', 'Program'].includes(item.fields['System.WorkItemType'])).length,
          TaskCount: siteItems.filter(item => ['Task', 'Bug', 'Issue', 'Requirement'].includes(item.fields['System.WorkItemType'])).length,
          Latitude: invData?.latitude || coords?.lat || null,
          Longitude: invData?.longitude || coords?.lon || null,
          LocationName: invData?.country ? `${invData.country} (${siteCode})` : (coords?.name || siteCode),
          UsesNewOTNetworkIP: invData?.usesNewOTNetwork || false,
          MonitoredSolarWindsOT: invData?.monitoredSolarWinds || false,
          MonitoredSinecNMSOT: invData?.monitoredSinecNMS || false,
          InOTvSphere: invData?.inOTvSphere || false,
          LocalOTDomainController: invData?.localOTDomainController || false,
          OTSubnetCID: invData?.otSubnetCID || false
        });
      });
      
      // Add inventory sites that weren't in work items
      if (inventory) {
        Object.keys(inventory).forEach(siteCode => {
          if (!siteCodes.includes(siteCode) && !['BEA', 'BNA', 'BSA'].includes(siteCode.toUpperCase())) {
            const invData = inventory[siteCode];
            siteCodes.push(siteCode);
            SITES.push({
              Site: siteCode,
              Region: invData.region || '',
              BusinessUnit: invData.bu || '',
              ProjectCount: 0,
              TaskCount: 0,
              Latitude: invData.latitude || null,
              Longitude: invData.longitude || null,
              LocationName: invData.country ? `${invData.country} (${siteCode})` : siteCode,
              UsesNewOTNetworkIP: invData.usesNewOTNetwork || false,
              MonitoredSolarWindsOT: invData.monitoredSolarWinds || false,
              MonitoredSinecNMSOT: invData.monitoredSinecNMS || false,
              InOTvSphere: invData.inOTvSphere || false,
              LocalOTDomainController: invData.localOTDomainController || false,
              OTSubnetCID: invData.otSubnetCID || false
            });
          }
        });
      }
      
      console.log('✅ [LOAD] Data processing complete:', {
        projects: PROJECTS.length,
        tasks: TASKS.length,
        sites: SITES.length,
        siteCodes: siteCodes.length
      });
      
      logDiag('Azure DevOps data loaded', {projects: PROJECTS.length, tasks: TASKS.length, sites: SITES.length});
      logDiag('SITES array:', SITES);
      logDiag('Site codes extracted:', siteCodes);
      logDiag('Inventory data loaded:', inventory);
      console.log('🔍 DEBUG: Inventory data', inventory);
      console.log('🔍 DEBUG: First site from inventory:', inventory ? Object.values(inventory)[0] : 'No inventory');
      console.log('🔍 DEBUG: SITES array', SITES);
      
      // Debug work item types
      const workItemTypes = [...new Set(workItems.map(item => item.fields['System.WorkItemType']))];
      logDiag('All work item types found:', workItemTypes);
      
      // Debug GSP-related items
      const gspItems = workItems.filter(item => 
        (item.fields['System.Title'] || '').toLowerCase().includes('gsp') ||
        (item.fields['System.AreaPath'] || '').toLowerCase().includes('gsp')
      );
      logDiag('GSP-related work items:', gspItems.map(item => ({
        id: item.id,
        title: item.fields['System.Title'],
        workItemType: item.fields['System.WorkItemType'],
        areaPath: item.fields['System.AreaPath'],
        state: item.fields['System.State']
      })));
      
      // Update debug display
      const debugEl = document.getElementById('coordsDebug');
      if (debugEl) {
        const sitesWithCoords = SITES.filter(s => s.Latitude && s.Longitude);
        debugEl.innerHTML = `Found ${sitesWithCoords.length} sites with coordinates out of ${SITES.length} total sites. Site codes: ${siteCodes.join(', ')}`;
      }
      
      return true;
    } catch (error) {
      console.error('❌ [LOAD] Failed to load Azure DevOps data:', error);
      console.error('❌ [LOAD] Error message:', error.message);
      console.error('❌ [LOAD] Error stack:', error.stack);
      logDiag('Failed to load Azure DevOps data:', error);
      throw error;
    }
  }

  async function getDevOpsWorkItems(org, project, token) {
    try {
      console.log('🔍 [API] Starting getDevOpsWorkItems:', {org, project, tokenLength: token?.length || 0});
      
      if (!org || !project || !token) {
        const err = `Missing required parameters: org=${!!org}, project=${!!project}, token=${!!token}`;
        console.error('❌ [API]', err);
        throw new Error(err);
      }
      
      // First, let's get the list of projects to find the correct project name
      const projectsUrl = `https://dev.azure.com/${org}/_apis/projects?api-version=7.0`;
      console.log('🔍 [API] Fetching projects from:', projectsUrl);
      
      const projectsResponse = await fetch(projectsUrl, {
        headers: {
          'Authorization': `Basic ${btoa(':' + token)}`,
          'Content-Type': 'application/json'
        }
      });
      
      console.log('🔍 [API] Projects response status:', projectsResponse.status, projectsResponse.statusText);
      
      if (!projectsResponse.ok) {
        const errorBody = await projectsResponse.text().catch(() => 'Unable to read error body');
        const err = `Failed to get projects: ${projectsResponse.status} ${projectsResponse.statusText}. Response: ${errorBody}`;
        console.error('❌ [API]', err);
        throw new Error(err);
      }
      
      const projectsData = await projectsResponse.json();
      const projects = projectsData.value || [];
      
      console.log('🔍 [API] Available projects:', projects.map(p => p.name));
      logDiag('Available projects:', projects.map(p => p.name));
      
      if (projects.length === 0) {
        const err = `No projects found in organization "${org}". Check that you have access to this organization.`;
        console.error('❌ [API]', err);
        throw new Error(err);
      }
      
      // Find the project by name (case-insensitive)
      const foundProject = projects.find(p => 
        p.name.toLowerCase() === project.toLowerCase() || 
        p.name.toLowerCase().includes('ot') ||
        p.name.toLowerCase().includes('infrastructure')
      );
      
      if (!foundProject) {
        const err = `Project "${project}" not found. Available projects: ${projects.map(p => p.name).join(', ')}`;
        console.error('❌ [API]', err);
        throw new Error(err);
      }
      
      const actualProjectName = foundProject.name;
      console.log('🔍 [API] Using project:', actualProjectName);
      logDiag('Using project:', actualProjectName);
      
      // Now get work items using the correct project name
      let url = `https://dev.azure.com/${org}/${encodeURIComponent(actualProjectName)}/_apis/wit/wiql?api-version=7.0`;
      
      // Get all work items
      const wiqlQuery = `
        SELECT [System.Id], [System.Title], [System.WorkItemType], [System.State], [System.AssignedTo], 
               [System.AreaPath], [System.IterationPath], [System.CreatedDate], [System.ChangedDate],
               [System.Description], [Custom.Region], [Custom.SiteCode],
               [Microsoft.VSTS.Scheduling.StartDate], [Microsoft.VSTS.Common.ClosedDate]
        FROM WorkItems 
        WHERE [System.TeamProject] = '${actualProjectName}'
        ORDER BY [System.ChangedDate] DESC
      `;
      
      console.log('🔍 [API] Executing WIQL query for project:', actualProjectName);
      console.log('🔍 [API] WIQL URL:', url);
      
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Basic ${btoa(':' + token)}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ query: wiqlQuery })
      });
      
      console.log('🔍 [API] WIQL response status:', response.status, response.statusText);
      
      if (!response.ok) {
        const errorText = await response.text().catch(() => 'Unable to read error body');
        const err = `Azure DevOps API error: ${response.status} ${response.statusText}. Details: ${errorText.substring(0, 500)}`;
        console.error('❌ [API]', err);
        throw new Error(err);
      }
      
      const queryResult = await response.json();
      console.log('🔍 [API] WIQL query result:', {workItemCount: queryResult.workItems?.length || 0, queryResult: queryResult});
      
      if (!queryResult.workItems || queryResult.workItems.length === 0) {
        console.warn('⚠️ [API] No work items found in project:', actualProjectName);
        logDiag('No work items found in project:', actualProjectName);
        return [];
      }
      
      console.log('✅ [API] Found work items:', queryResult.workItems.length);
      logDiag('Found work items:', queryResult.workItems.length);
      
      // Get detailed work item data
      // Azure DevOps limits work item requests to 200 items at a time, so we need to batch them
      const workItemIds = queryResult.workItems.map(item => item.id);
      const batchSize = 200; // Azure DevOps limit
      const allWorkItems = [];
      
      console.log('🔍 [API] Fetching work item details for', workItemIds.length, 'items in batches of', batchSize);
      
      // Process in batches
      for (let i = 0; i < workItemIds.length; i += batchSize) {
        const batch = workItemIds.slice(i, i + batchSize);
        const batchNumber = Math.floor(i / batchSize) + 1;
        const totalBatches = Math.ceil(workItemIds.length / batchSize);
        
        console.log(`🔍 [API] Fetching batch ${batchNumber}/${totalBatches} (${batch.length} items)`);
        
        const detailsUrl = `https://dev.azure.com/${org}/${encodeURIComponent(actualProjectName)}/_apis/wit/workitems?ids=${batch.join(',')}&api-version=7.0&$expand=all`;
        
        const detailsResponse = await fetch(detailsUrl, {
          headers: {
            'Authorization': `Basic ${btoa(':' + token)}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log(`🔍 [API] Batch ${batchNumber} response status:`, detailsResponse.status, detailsResponse.statusText);
        
        if (!detailsResponse.ok) {
          const errorBody = await detailsResponse.text().catch(() => 'Unable to read error body');
          const err = `Azure DevOps details API error (batch ${batchNumber}): ${detailsResponse.status} ${detailsResponse.statusText}. Response: ${errorBody.substring(0, 500)}`;
          console.error('❌ [API]', err);
          throw new Error(err);
        }
        
        const detailsResult = await detailsResponse.json();
        const batchWorkItems = detailsResult.value || [];
        allWorkItems.push(...batchWorkItems);
        
        console.log(`✅ [API] Batch ${batchNumber} completed: ${batchWorkItems.length} items retrieved`);
        
        // Small delay between batches to avoid rate limiting
        if (i + batchSize < workItemIds.length) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }
      }
      
      console.log('✅ [API] All batches complete. Retrieved', allWorkItems.length, 'work items total');
      
      return allWorkItems;
      
    } catch (error) {
      console.error('❌ [API] Error getting Azure DevOps work items:', error);
      console.error('❌ [API] Error stack:', error.stack);
      logDiag('Error getting Azure DevOps work items:', error);
      throw error;
    }
  }

  function extractBusinessUnit(areaPath) {
    if (areaPath.includes('BEA')) return 'BEA';
    if (areaPath.includes('BNA')) return 'BNA';
    if (areaPath.includes('BSA')) return 'BSA';
    return 'Other';
  }

  function extractYear(iterationPath) {
    const yearMatch = iterationPath.match(/(\d{4})/);
    return yearMatch ? parseInt(yearMatch[1]) : new Date().getFullYear();
  }


  // Prompt for DevOps credentials on load
  console.log('🔍 [MAIN] About to prompt for credentials...');
  let credentialsProvided = false;
  try {
    credentialsProvided = await promptForDevOpsCredentials();
    console.log('🔍 [MAIN] Credentials provided:', credentialsProvided);
  } catch (error) {
    console.error('❌ [MAIN] Error getting credentials:', error);
    showErr('Error getting credentials: ' + (error.message || error));
  }
  
  if (credentialsProvided) {
    console.log('🔍 [MAIN] Setting up auto-load with timeout...');
    // Auto-load data from Azure DevOps after a short delay to ensure page is ready
    setTimeout(async () => {
      try {
        console.log('🔍 [MAIN] Timeout fired, calling loadDataFromDevOps...');
        await loadDataFromDevOps();
        
        // Continue with existing rendering logic
        next("Rendering…");
        
        // Update UI elements and KPIs
        updateUIAndKPIs();

        // Update site picker
        const siteOptions = siteCodes.slice().sort();
        logDiag('Populating site picker with options:', siteOptions);
        document.getElementById("sitePick").innerHTML=`<option value="">Select a site</option>`+siteOptions.map(s=>`<option>${s}</option>`).join("");
        
        // Update task status filter
        const taskStatuses = uniq(TASKS.map(t=>t.Status||'')).sort();
        fill(document.getElementById("fTaskStatus"), taskStatuses, "Task Status");

        // Render the dashboard
        render(); 
        renderTasks();
        
        // Update status
        statusEl.textContent = `Loaded Projects: ${PROJECTS.length} • Tasks: ${TASKS.length} • Sites: ${SITES.length} (from Azure DevOps)`;
        logDiag('Azure DevOps data loaded and rendered', {projects:PROJECTS.length, tasks:TASKS.length, sites:SITES.length});
        
        // Hide the Azure DevOps configuration section after successful load
        document.getElementById('devOpsConfig').style.display = 'none';
        
        hideLoader();
        
      } catch (error) {
        console.error('❌ [MAIN] Error in auto-load:', error);
        console.error('❌ [MAIN] Error message:', error.message);
        console.error('❌ [MAIN] Error stack:', error.stack);
        showErr('Failed to load data from Azure DevOps: ' + (error.message || error));
        logDiag('Azure DevOps load error:', error);
        hideLoader();
      }
    }, 500);
  } else {
    console.warn('⚠️ [MAIN] Credentials not provided, skipping auto-load');
    showErr('Please provide your Personal Access Token to load data.');
  }

  // Column audit (after normalization)
  try{
    function audit(label, rows, critical, recommended){
      const present = new Set(Object.keys((rows&&rows[0])||{}));
      const missCrit = (critical||[]).filter(k=> !present.has(k));
      const missRec = (recommended||[]).filter(k=> !present.has(k));
      logDiag('Column audit '+label, {present: Array.from(present).sort(), missing_critical: missCrit, missing_recommended: missRec});
    }
    audit('SITES', SITES,
      ['Site','Region','BusinessUnit','Country'],
      ['Latitude','Longitude','UsesNewOTNetworkIP','MonitoredSolarWindsOT','MonitoredSinecNMSOT','InOTvSphere','LocalOTDomainController','OTSubnetCIDR','EffectiveDate']
    );
    audit('TASKS', TASKS,
      ['Site','TaskId','TaskName'],
      ['TaskType','Status','PlannedDate','CompletedDate','Owner']
    );
    audit('PROJECTS', PROJECTS,
      ['Site','ProjectType','Project','Status'],
      ['Year','BeforeState','AfterState','KeyBenefits','Owner','Latitude','Longitude']
    );
  }catch{}

  // Canonical site codes (updated from SITES data)
  siteCodes = uniq(SITES.map(s=> s && s.Site ? String(s.Site).trim().toUpperCase() : '')).filter(v=> /^[A-Z]{3}$/.test(v));
  const inferSiteCode = (name)=>{
    const s = String(name||'').trim().toUpperCase();
    if(/^[A-Z]{3}$/.test(s)) return s;
    if(!s) return '';
    let best=null, bestScore=-1;
    for(const code of siteCodes){
      let idx=-1, ok=true, score=0;
      for(const ch of code){
        const pos = s.indexOf(ch, idx+1);
        if(pos===-1){ ok=false; break; }
        score += (100 - pos);
        idx = pos;
      }
      if(ok && score>bestScore){ bestScore=score; best=code; }
    }
    return best || (s.match(/[A-Z]{3}/)?.[0] || '');
  };
  TASKS.forEach(t=>{ const c=inferSiteCode(t.Site); if(c) t.Site=c; });
  PROJECTS.forEach(p=>{ const c=inferSiteCode(p.Site); if(c) p.Site=c; });

  // Function to update UI and KPIs after data is loaded
  function updateUIAndKPIs(){
    // UI + KPIs
    const types=uniq(PROJECTS.map(p=>p.ProjectType)).sort();
    // BU list derived from SITES to ensure coverage even if projects are missing in a BU
    const bus=uniq(SITES.map(getBU)).filter(v=>v && v!=='Other');
    const years=uniq(PROJECTS.map(p=>p.Year)).sort((a,b)=>String(a).localeCompare(String(b)));
    const statuses=uniq(PROJECTS.map(p=>p.Status||'')).sort();
    fill(document.getElementById('fBU'), (bus.length?bus:['BEA','BNA','BSA']).sort(), 'Region');
    fill(document.getElementById("fType"),types,"Types");
    fill(document.getElementById("fYear"),years,"Years");
    fill(document.getElementById("fStatus"),statuses,"Statuses");

    const countTrue=col=>SITES.filter(s=> s && toBool(s[col])===true).length;
    // Inventory KPIs
    const invDefs=[
      {name:"New OT Network IP",col:"UsesNewOTNetworkIP"},
      {name:"Monitored (SolarWinds OT)",col:"MonitoredSolarWindsOT"},
      {name:"Monitored (SINEC OT)",col:"MonitoredSinecNMSOT"},
      {name:"In OT vSphere",col:"InOTvSphere"},
      {name:"Local OT Domain Controller",col:"LocalOTDomainController"}
    ];
    const invHtml=invDefs.map(k=>`<div class="card"><div class="label">${k.name}</div><div class="value">${countTrue(k.col)}</div></div>`).join("");
    
    // Debug KPI calculations
    console.log('🔍 KPI Debug - SITES array length:', SITES.length);
    console.log('🔍 KPI Debug - Sample site (first):', SITES[0]);
    console.log('🔍 KPI Debug - KPI counts:', Object.fromEntries(invDefs.map(k=>{
      const count = countTrue(k.col);
      const sample = SITES.filter(s=> s && toBool(s[k.col])===true).slice(0, 2);
      console.log(`   ${k.name}: count=${count}, sample sites:`, sample);
      return [k.col, count];
    })));
    
    logDiag('Inventory KPI counts', Object.fromEntries(invDefs.map(k=>[k.col, countTrue(k.col)])));
    const buSel = document.getElementById('fBU').value;
    if(!buSel){
      const buCards = ['BEA','BNA','BSA'].map(b=>{
        const nSites = SITES.filter(s=> getBU(s)===b).length || 0;
        return `<div class="card bu ${b}"><div class="label">${b}</div><div class="value">${nSites}</div></div>`;
      }).join('');
      document.getElementById("kpiInventory").innerHTML = invHtml + `<div class="kpi bu-strip">${buCards}</div>`;
    } else {
      document.getElementById("kpiInventory").innerHTML = invHtml;
    }
  }

  function render(){
    console.log('🔍 render() called - PROJECTS:', PROJECTS.length, 'SITES:', SITES.length);
    const bu=document.getElementById('fBU').value, t=document.getElementById("fType").value, y=document.getElementById("fYear").value, s=document.getElementById("fStatus").value;
    let rows=PROJECTS.slice();
    if(bu){
      // When filtering by region, include Programs from the original work items
      if (window.originalWorkItems && window.originalWorkItems.length > 0) {
        const programItems = window.originalWorkItems.filter(item => 
          item.fields['System.WorkItemType'] === 'Program' &&
          !shouldExcludeItem(item.fields['System.AreaPath'])
        ).map(item => ({
          id: item.id,
          Project: item.fields['System.Title'],
          Status: item.fields['System.State'],
          Owner: item.fields['System.AssignedTo']?.displayName || '',
          Region: item.fields['Custom.Region'] || '',
          ProjectType: 'Program',
          BusinessUnit: extractBusinessUnit(item.fields['System.AreaPath'] || ''),
          Year: extractYear(item.fields['System.IterationPath'] || ''),
          Latitude: null,
          Longitude: null
        }));
        rows = [...rows, ...programItems];
      }
      // Filter projects by sites that belong to the selected BU (canonical from SITES)
      const buSites = new Set(SITES.filter(s=> getBU(s)===bu).map(s=> normSite(s.Site)));
      rows = rows.filter(r=> buSites.has(normSite(r.Site)));
    }
    if(t) rows=rows.filter(r=>r.ProjectType===t);
    if(y) rows=rows.filter(r=>String(r.Year)===y);
    if(s) rows=rows.filter(r=>r.Status===s);

    const done=rows.filter(r=>(r.Status||"").toLowerCase()==="completed").length;
    const prog=rows.filter(r=>(r.Status||"").toLowerCase()==="in progress").length;
    document.getElementById("kpiProjects").innerHTML=`
      <div class="card"><div class="label">Total Projects</div><div class="value">${rows.length}</div></div>
      <div class="card"><div class="label">Completed</div><div class="value">${done}</div></div>
      <div class="card"><div class="label">In Progress</div><div class="value">${prog}</div></div>
      <div class="card"><div class="label">Sites</div><div class="value">${new Set(rows.map(r=>r.Site)).size}</div></div>`;

    document.getElementById("cards").innerHTML=rows.map(r=>{
      const pill=r.Status==="Completed"?"done":(r.Status==="In Progress"?"prog":"other");
      const bu = getBU(r);
      
      // Find site coordinates for this project's site
      const siteData = SITES.find(s => s.Site === r.Site);
      logDiag(`Project ${r.Project || r.Title}: Site=${r.Site}, Found siteData:`, siteData);
      const coords = (siteData && siteData.Latitude && siteData.Longitude) ? 
        `${siteData.Latitude}, ${siteData.Longitude}` : "Not set";
      const locationName = siteData?.LocationName || r.Site;
      logDiag(`Project ${r.Project || r.Title}: coords=${coords}, locationName=${locationName}`);
      
      return `<div class="row">
        <div class="top"><span><b>[${r.ProjectType||""}] ${r.Project||r.Title||""}</b> — ${locationName} <span class="bu bu-${bu}">${bu}</span></span>
          <span class="pill ${pill}">${r.Status||""}</span></div>
        <div class="meta">
          <div><b>ID:</b> ${r.id||""} <b>Area Path:</b> ${r.AreaPath||""} <b>Iteration:</b> ${r.IterationPath||""} <b>Completed:</b> ${formatDate(r.CompletedDate||r.Completed)||"Not completed"} <b>Coordinates:</b> ${coords}</div>
          <div><b>Description:</b> ${(r.Description||"").substring(0, 200)}${(r.Description||"").length > 200 ? "..." : ""}</div>
        </div>
        <div class="grid">
          <div class="box before"><b>Before</b><div>${(r.BeforeState||"").replace(/\n/g,"<br>")}</div></div>
          <div class="box after"><b>After</b><div>${(r.AfterState||"").replace(/\n/g,"<br>")}</div></div>
        </div>
        ${r.KeyBenefits?`<div style="margin-top:6px">Benefits: ${r.KeyBenefits}</div>`:""}
      </div>`;
    }).join("");

    // CSV export disabled for launch (can be re-enabled later)
    document.getElementById("btnExport").style.display='none';
    
    // Map rendering - always collect coordinates (even if map not visible yet)
    try {
      // Collect coordinates from both PROJECTS (rows) and SITES
      const siteCoordsMap = new Map(); // site -> {lat, lon, projects: []}
      
      console.log('🔍 Starting coordinate collection - rows:', rows.length, 'SITES:', SITES ? SITES.length : 'undefined');
      
      // First, collect coordinates from filtered projects
      rows.forEach(p => {
      const {lat, lon} = fixLatLon(p.Latitude, p.Longitude);
      if (!isNaN(lat) && !isNaN(lon)) {
        const site = (p.Site || '').toString().trim().toUpperCase();
        if (site) {
          if (!siteCoordsMap.has(site)) {
            siteCoordsMap.set(site, {lat, lon, projects: []});
          }
          siteCoordsMap.get(site).projects.push(p);
        }
      }
    });
    
    // Then, add SITES coordinates (for sites without project coordinates)
    SITES.forEach(s => {
      const siteCode = (s.Site || '').toString().trim().toUpperCase();
      if (!siteCode || siteCoordsMap.has(siteCode)) return; // Skip if already have coords from projects
      
      const {lat, lon} = fixLatLon(s.Latitude, s.Longitude);
      if (!isNaN(lat) && !isNaN(lon)) {
        siteCoordsMap.set(siteCode, {lat, lon, projects: []});
        // Find any projects for this site
        rows.filter(p => (p.Site || '').toString().trim().toUpperCase() === siteCode)
            .forEach(p => siteCoordsMap.get(siteCode).projects.push(p));
      }
    });
    
      console.log('🔍 Map Debug in render() - Sites with coordinates:', siteCoordsMap.size);
      if(siteCoordsMap.size > 0){
        const sampleSites = Array.from(siteCoordsMap.entries()).slice(0, 5).map(([site, data]) => ({
          site,
          lat: data.lat,
          lon: data.lon,
          projectCount: data.projects.length
        }));
        console.log('🔍 Map Debug - Sample sites with coordinates:', sampleSites);
        
        // Also check first few SITES to see their coordinate values
        console.log('🔍 Map Debug - First 3 SITES coordinate values:', SITES.slice(0, 3).map(s => ({
          Site: s.Site,
          Latitude: s.Latitude,
          Longitude: s.Longitude,
          parsed: fixLatLon(s.Latitude, s.Longitude)
        })));
      } else {
        console.log('🔍 Map Debug - No coordinates found. Sample SITES:', SITES.slice(0, 3).map(s => ({
          Site: s.Site,
          Latitude: s.Latitude,
          Longitude: s.Longitude
        })));
      }
      
      // Always initialize map if needed (regardless of visibility - markers will show when map is toggled on)
      if (!map && window.L && typeof window.L.map === 'function') {
        const mapEl = document.getElementById("map");
        if (mapEl) {
          try {
            map = L.map("map", {
              attributionControl: false,
              minZoom: 2,
              maxZoom: 18,
              worldCopyJump: true // Prevent tile repetition
            }).setView([20, 0], 2);
            
            const tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
              minZoom: 2,
              maxZoom: 18,
              noWrap: false // Allow tiles to wrap around the world
            });
            tileLayer.addTo(map);
            logDiag('Map initialized in render()');
            console.log('🔍 Map initialized in render()');
          } catch (error) {
            logDiag('Leaflet map initialization failed in render():', error);
            console.error('🔍 Map initialization error:', error);
          }
        }
      }
      
        // Always add markers if map is available (even if hidden)
      if (map && siteCoordsMap.size > 0) {
        // Clear existing markers and circle markers (including pulse rings)
        map.eachLayer(layer => {
          if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
            // Stop any pulse intervals if they exist
            if (layer._pulseInterval) {
              clearInterval(layer._pulseInterval);
              delete layer._pulseInterval;
            }
            // Clean up any pulse rings
            if (layer._pulseRings && Array.isArray(layer._pulseRings)) {
              layer._pulseRings.forEach(ring => {
                if (map.hasLayer(ring)) map.removeLayer(ring);
              });
              delete layer._pulseRings;
            }
            map.removeLayer(layer);
          } else if (layer instanceof L.Circle && layer.options && (layer.options.dashArray === '10, 10' || layer.options.className === 'map-beacon')) {
            // Remove pulse rings
            if (map.hasLayer(layer)) map.removeLayer(layer);
          }
        });
        
        const markers = [];
        
        // Create markers for each site (using coordinates collected above)
        console.log('🔍 Creating markers for', siteCoordsMap.size, 'sites on map');
        siteCoordsMap.forEach((data, siteCode) => {
          try {
            const projList = data.projects || [];
            const hasActiveProjects = projList.length > 0;
            
            // Different marker styles based on whether site has active projects
            let markerOptions;
            if (hasActiveProjects) {
              // Active project marker: larger, bright orange/red, with beacon effect
              markerOptions = {
                radius: 11,
                weight: 3,
                color: '#FFFFFF',
                fillColor: '#F59E0B', // Amber/orange for active projects
                fillOpacity: 0.9
              };
            } else {
              // Inventory-only marker: smaller, light blue for better visibility
              markerOptions = {
                radius: 6,
                weight: 2,
                color: '#60A5FA', // Blue border
                fillColor: '#3B82F6', // Light blue fill
                fillOpacity: 0.7
              };
            }
            
            const marker = L.circleMarker([data.lat, data.lon], markerOptions);
            
            // Add pulsing beacon effect for active projects using a pulsing circle behind the marker
            if (hasActiveProjects) {
              // Make marker larger and more prominent
              marker.setStyle({
                radius: 12,
                weight: 3,
                fillColor: '#EF4444', // Red for high visibility
                color: '#FFFFFF'
              });
              
              // Add a pulsing ring animation
              let pulseRing = null;
              const updatePulse = () => {
                if (pulseRing) map.removeLayer(pulseRing);
                pulseRing = L.circle([data.lat, data.lon], {
                  radius: 30000, // ~30km radius for visible pulse
                  color: '#F59E0B',
                  weight: 3,
                  fill: false,
                  opacity: 0.5,
                  dashArray: '10, 10',
                  className: 'map-beacon'
                }).addTo(map);
                
                // Store reference on marker for cleanup
                if (!marker._pulseRings) marker._pulseRings = [];
                marker._pulseRings.push(pulseRing);
                
                // Fade out and remove after 2 seconds
                setTimeout(() => {
                  if (pulseRing && map.hasLayer(pulseRing)) {
                    // Fade out animation
                    let opacity = 0.5;
                    const fadeInterval = setInterval(() => {
                      opacity -= 0.1;
                      if (opacity <= 0 || !map.hasLayer(pulseRing)) {
                        clearInterval(fadeInterval);
                        map.removeLayer(pulseRing);
                        if (marker._pulseRings) {
                          const idx = marker._pulseRings.indexOf(pulseRing);
                          if (idx > -1) marker._pulseRings.splice(idx, 1);
                        }
                      } else {
                        pulseRing.setStyle({ opacity });
                      }
                    }, 100);
                  }
                }, 1800);
              };
              
              // Start pulsing animation
              updatePulse();
              const pulseInterval = setInterval(updatePulse, 2000);
              
              // Store interval for cleanup
              marker._pulseInterval = pulseInterval;
            }
            
            // Build popup content
            let popupHtml = `<div style="min-width: 200px;"><b>${siteCode}</b>`;
            if (hasActiveProjects) {
              popupHtml += ` <span style="background: #F59E0B; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold;">ACTIVE PROJECTS</span>`;
              popupHtml += `<div style="margin-top: 4px;">`;
              projList.forEach(p => {
                const type = p.ProjectType ? `<b>[${p.ProjectType}]</b> ` : '';
                const status = p.Status ? ` <span style="color:#6B7280">(${p.Status})</span>` : '';
                popupHtml += `<div>${type}${p.Project || ''}${status}</div>`;
              });
              popupHtml += `</div>`;
            } else {
              popupHtml += ` <span style="color: #3B82F6; font-size: 11px;">(Site Location)</span>`;
            }
            popupHtml += `<div style="margin-top: 4px; font-size: 11px; color: #6B7280;">${data.lat.toFixed(4)}, ${data.lon.toFixed(4)}</div></div>`;
            
            marker.bindPopup(popupHtml);
            marker.addTo(map);
            markers.push(marker);
            
            const markerType = hasActiveProjects ? 'ACTIVE PROJECT' : 'inventory-only';
            if(markers.length <= 5) console.log(`🔍 Added ${markerType} marker for ${siteCode} at [${data.lat}, ${data.lon}]`);
          } catch(error) {
            console.error(`🔍 Error creating marker for ${siteCode}:`, error);
          }
        });
        
        // Fit map to show all markers, but ensure world view is maintained
        if (markers.length > 0) {
          try {
            const group = L.featureGroup(markers);
            const bounds = group.getBounds();
            
            // Check if bounds are reasonable (not too zoomed in)
            const boundsWidth = bounds.getEast() - bounds.getWest();
            const boundsHeight = bounds.getNorth() - bounds.getSouth();
            
            // If bounds are very small (likely clustered markers), use world view
            if (boundsWidth < 5 || boundsHeight < 5) {
              // Markers are clustered - show world view
              map.setView([20, 0], 2);
              console.log(`🔍 Markers clustered - showing world view`);
            } else if (boundsWidth > 150) {
              // Markers span too wide - show world view to avoid tile repetition issues
              map.setView([20, 0], 2);
              console.log(`🔍 Markers span too wide (${boundsWidth.toFixed(1)}°) - showing world view`);
            } else {
              // Normal case: fit to bounds with padding, but limit max zoom to ensure world remains visible
              // Clamp longitude to prevent tile wrapping issues
              const east = Math.min(bounds.getEast(), 179);
              const west = Math.max(bounds.getWest(), -179);
              const north = Math.min(bounds.getNorth(), 85);
              const south = Math.max(bounds.getSouth(), -85);
              
              const clampedBounds = L.latLngBounds([[south, west], [north, east]]);
              map.fitBounds(clampedBounds.pad(0.1), {
                maxZoom: 5 // Limit max zoom to keep world view
              });
              console.log(`🔍 Map fitted to bounds with ${markers.length} markers. Bounds:`, clampedBounds.toBBoxString());
            }
            logDiag('Map bounds set to show all markers', {count: markers.length});
          } catch(error) {
            console.error('🔍 Error fitting map bounds:', error);
            // Fallback to world view
            map.setView([20, 0], 2);
          }
        } else {
          // No markers - show world view
          map.setView([20, 0], 2);
          console.log('🔍 No markers created - siteCoordsMap size:', siteCoordsMap.size, 'map exists:', !!map);
          logDiag('No markers to display on map. SITES array:', SITES.length);
        }
        
        // Invalidate size to ensure proper rendering
        setTimeout(() => map.invalidateSize(), 100);
      }
    } catch(error) {
      console.error('🔍 Map rendering error:', error);
      logDiag('Map rendering error', error);
    }
  }

  function normSite(v){ const s=String(v||'').trim().toUpperCase(); const m=s.match(/[A-Z]{3}/); return m? m[0] : s; }
  function renderTasks(){
    const sel=normSite(document.getElementById("sitePick").value);
    const taskStatusFilter = document.getElementById("fTaskStatus").value;
    let rows = sel? TASKS.filter(t=> normSite(t.Site)===sel) : TASKS.slice();
    
    // Normalize status case and common variants
    const normStatus=s=>{ const v=String(s||'').trim().toLowerCase();
      if(!v) return '';
      if(v.includes('progress')) return 'In Progress';
      if(v.includes('active') || v.startsWith('in-work') || v.startsWith('committed')) return 'In Progress';
      if(v.startsWith('plan') || v==='new' || v==='open' || v==='backlog') return 'Planned';
      if(v.startsWith('comp') || v==='done' || v==='closed' || v==='resolved' || v==='complete' || v==='completed') return 'Completed';
      if(v.startsWith('block') || v==='hold' || v==='on hold' || v==='cancelled' || v==='canceled') return 'Blocked';
      return s||'';
    };
    const deriveStatus=(r)=>{
      const base = normStatus(r.Status);
      if(base) return base;
      // Heuristic: if CompletedDate present → Completed; else if PlannedDate present and date in future/past → Planned/In Progress
      const c = r.CompletedDate || r.Completed; const p = r.PlannedDate || r.Planned;
      if(c && String(c).trim()!=='') return 'Completed';
      if(p && String(p).trim()!=='') return 'Planned';
      return '';
    };
    
    // Apply task status filter if selected
    if(taskStatusFilter) {
      rows = rows.filter(t => {
        const taskStatus = deriveStatus(t);
        return taskStatus === taskStatusFilter;
      });
    }
    const rowsN = rows.map(r=>({ ...r, Status: deriveStatus(r)}));
    const buckets = { 'Planned':0, 'In Progress':0, 'Completed':0, 'Blocked':0 };
    rowsN.forEach(r=>{ if(buckets.hasOwnProperty(r.Status)) buckets[r.Status]++; });
    const counts=["Planned","In Progress","Completed","Blocked"].map(st=>({st,n:buckets[st]}));
    document.getElementById("taskStatus").innerHTML=counts.map(c=>`<div class="card"><div class="label">${c.st}</div><div class="value">${c.n}</div></div>`).join("");
    if(!rowsN.length){ document.getElementById("tasks").innerHTML=""; return; }
    const baseCols=[
      {key:"Site", label:"Site", get:(r)=> r.Site||""},
      {key:"TaskId", label:"TaskId", get:(r)=> r.TaskId||r.TaskID||r.id||""},
      {key:"TaskName", label:"TaskName", get:(r)=> r.TaskName||r.Task||r.Project||r.Title||""},
      {key:"TaskType", label:"TaskType", get:(r)=> r.TaskType||r.Type||r.Category||r.Domain||""},
      {key:"Status", label:"Status", get:(r)=> { const s=normStatus(r.Status)||""; const c = s==="Completed"?"completed":(s==="In Progress"?"inprogress":(s==="Blocked"?"blocked":"planned")); return `<span><span class=\"status-dot ${c}\"></span>${s}</span>`; }},
      {key:"PlannedDate", label:"PlannedDate", get:(r)=> formatDate(r.PlannedDate||r.Planned)},
      {key:"CompletedDate", label:"CompletedDate", get:(r)=> formatDate(r.CompletedDate||r.Completed)},
    ];
    // Get configured fields to display from multi-select dropdown
    const configuredFields = Array.from(document.getElementById('devOpsFields')?.selectedOptions || [])
      .map(option => option.value).filter(Boolean);
    
    const skipKeys = new Set(["BusinessUnit","Region","Country","Project","Description"]);
    let extraKeys = [];
    
    if (configuredFields.length > 0) {
      // Use only configured fields
      extraKeys = configuredFields.filter(k => 
        !skipKeys.has(k) && 
        !baseCols.some(c=>c.key===k || c.label===k)
      );
    } else {
      // Fallback to auto-detection with filtering
      extraKeys = Array.from(new Set(rowsN.flatMap(r=>Object.keys(r)))).filter(k=> 
        !skipKeys.has(k) && 
        !baseCols.some(c=>c.key===k || c.label===k) &&
        !k.toLowerCase().includes('description') &&
        !k.toLowerCase().includes('email') &&
        !k.toLowerCase().includes('comment') &&
        !k.toLowerCase().includes('note') &&
        k !== 'id' &&
        k !== 'url' &&
        k !== 'rev' &&
        k !== 'fields'
      );
    }
    
    const allCols = baseCols.concat(extraKeys.map(k=>({key:k,label:k,get:(r)=> r[k]??""})));
    const th = `<tr>${allCols.map(c=>`<th>${c.label}</th>`).join("")}</tr>`;
    const tr = rowsN.map(r=>{
      const rowCls = r.Status==='Completed' ? 'completed' : (r.Status==='In Progress' ? 'inprogress' : (r.Status==='Blocked' ? 'blocked' : 'planned'));
      return `<tr class="task-row ${rowCls}">${allCols.map(c=>{
      const v=c.get(r);
      const isHtml = typeof v==='string' && v.indexOf('<span class=')===0;
      const val=isHtml? v : ((v && typeof v==='string')?v: (v?String(v):''));
      return isHtml? `<td>${val}</td>` : `<td>${val}</td>`;
    }).join("")}</tr>`;
    }).join("");
    document.getElementById("tasks").innerHTML=`<table><thead>${th}</thead><tbody>${tr}</tbody></table>`;
  }

  function formatDate(v){
    if(!v) return '';
    try{
      if(typeof v==='number'){
        if(v>=1900 && v<=2200) return String(v);
        if(v>25569 && v<60000){ const ms = (v - 25569) * 86400000; const d=new Date(ms); return d.toISOString().substring(0,10); }
        return String(v);
      }
      if(v instanceof Date) return v.toISOString().substring(0,10);
      const s=String(v).trim();
      if(/^\d{4}$/.test(s)) return s;
      const d=new Date(s); if(!isNaN(d.getTime())) return d.toISOString().substring(0,10);
      return s;
    }catch{ return String(v); }
  }

  // Hook UI
  ["fType","fYear","fStatus","fBU"].forEach(id=>document.getElementById(id).addEventListener("change",()=>{ render(); }));
  const siteOptions = siteCodes.slice().sort();
  logDiag('Populating site picker (main scope) with options:', siteOptions);
  document.getElementById("sitePick").innerHTML=`<option value="">Select a site</option>`+siteOptions.map(s=>`<option>${s}</option>`).join("");
  document.getElementById("sitePick").addEventListener("change",renderTasks);
  
  // Update task status filter
  const taskStatuses = uniq(TASKS.map(t=>t.Status||'')).sort();
  fill(document.getElementById("fTaskStatus"), taskStatuses, "Task Status");
  document.getElementById("fTaskStatus").addEventListener("change", renderTasks);


  // Theme toggle functionality
  function initializeTheme() {
    const savedTheme = localStorage.getItem('ot-dashboard-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    
    // Also apply to the main app container
    const otapp = document.getElementById('otapp');
    if (otapp) {
      otapp.setAttribute('data-theme', savedTheme);
    }
    
    updateThemeToggleIcon(savedTheme);
  }

  function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    // Apply theme to document element
    document.documentElement.setAttribute('data-theme', newTheme);
    
    // Also apply to the main app container
    const otapp = document.getElementById('otapp');
    if (otapp) {
      otapp.setAttribute('data-theme', newTheme);
    }
    
    localStorage.setItem('ot-dashboard-theme', newTheme);
    updateThemeToggleIcon(newTheme);
    
    logDiag('Theme changed to:', newTheme);
  }

  function updateThemeToggleIcon(theme) {
    const toggle = document.getElementById('themeToggle');
    const icon = toggle?.querySelector('.theme-icon');
    if (toggle && icon) {
      icon.textContent = theme === 'dark' ? '☀️' : '🌙';
      toggle.title = theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode';
    }
  }

  // Initialize theme on page load
  initializeTheme();

  // Theme toggle event listener
  document.getElementById('themeToggle').addEventListener('click', toggleTheme);

  // Prompt for DevOps PAT on load
  async function promptForDevOpsCredentials() {
    console.log('🔍 [PROMPT] Starting promptForDevOpsCredentials');
    try {
      const token = prompt('🔑 Enter your Azure DevOps Personal Access Token:');
      
      if (!token || token.trim() === '') {
        console.warn('⚠️ [PROMPT] User canceled or provided empty token');
        showErr('Personal Access Token is required to load data from Azure DevOps.');
        return false;
      }
      
      console.log('✅ [PROMPT] Token provided, length:', token.length);
      
      // Set the form values with known values
      const orgEl = document.getElementById('devOpsOrg');
      const projectEl = document.getElementById('devOpsProject');
      const tokenEl = document.getElementById('devOpsToken');
      
      if (!orgEl || !projectEl || !tokenEl) {
        const err = 'Required form elements not found. Missing: ' + 
          (!orgEl ? 'devOpsOrg ' : '') + 
          (!projectEl ? 'devOpsProject ' : '') + 
          (!tokenEl ? 'devOpsToken' : '');
        console.error('❌ [PROMPT]', err);
        showErr(err);
        return false;
      }
      
      orgEl.value = 'BungeDev';
      projectEl.value = 'OT Global Infrastructure';
      tokenEl.value = token;
      
      console.log('✅ [PROMPT] Form values set:', {
        org: orgEl.value,
        project: projectEl.value,
        tokenLength: tokenEl.value.length
      });
      
      return true;
    } catch (error) {
      console.error('❌ [PROMPT] Error in promptForDevOpsCredentials:', error);
      showErr('Error getting credentials: ' + (error.message || error));
      return false;
    }
  }


  document.getElementById('btnLoadDevOps').addEventListener('click', async function() {
    try {
      this.disabled = true;
      this.textContent = 'Loading...';
      
      await loadDataFromDevOps();
      
      // Continue with existing rendering logic
      next("Rendering…");
      
      // Update UI elements and KPIs
      updateUIAndKPIs();

      // Update site picker
      const siteOptions = siteCodes.slice().sort();
      document.getElementById("sitePick").innerHTML=`<option value="">Select a site</option>`+siteOptions.map(s=>`<option>${s}</option>`).join("");
      
      // Update task status filter
      const taskStatuses = uniq(TASKS.map(t=>t.Status||'')).sort();
      fill(document.getElementById("fTaskStatus"), taskStatuses, "Task Status");

      // Render the dashboard
      render(); 
      renderTasks();
      
      // Update status
      statusEl.textContent = `Loaded Projects: ${PROJECTS.length} • Tasks: ${TASKS.length} • Sites: ${SITES.length} (from Azure DevOps)`;
      logDiag('Azure DevOps data loaded and rendered', {projects:PROJECTS.length, tasks:TASKS.length, sites:SITES.length});
      
      // Hide the Azure DevOps configuration section after successful load
      document.getElementById('devOpsConfig').style.display = 'none';
      
      hideLoader();
      
      this.textContent = 'Reload from Azure DevOps';
      this.disabled = false;
      
    } catch (error) {
      this.disabled = false;
      this.textContent = 'Load from Azure DevOps';
      
      showErr('Failed to load data from Azure DevOps: ' + (error.message || error));
      logDiag('Azure DevOps load error:', error);
    }
  });

  // Map toggle (hidden by default)
  try{
    const tgl=document.getElementById('toggleMap');
    const mapEl=document.getElementById('map');
    const noteEl=document.getElementById('mapNote');
    if(tgl&&mapEl&&noteEl){
      tgl.checked=false;
      tgl.addEventListener('change',()=>{
        const on=tgl.checked;
        mapEl.style.display=on?'':'none';
        noteEl.style.display=on?'':'none';
        try{ 
          if(on && map){
            // Re-render markers when map is toggled on
            setTimeout(()=>{ 
              try{ 
                render(); // Re-render to add markers
                map.invalidateSize(); 
                console.log('🔍 Map toggle ON - Triggered render() to add markers');
              }catch(e){ logDiag('Map toggle render error:', e); }
            }, 100);
          } else if(on && window.L && mapRendered){ 
            setTimeout(()=>{ 
              try{ 
                const mEl=document.getElementById('map'); 
                if(mEl && mEl._leaflet_id && window.L && window.L.Map && window.L.map){ 
                  map.invalidateSize(); 
                }
              }catch(e){ logDiag('Map invalidateSize error:', e); }
            }, 50); 
          }
        }catch(e){ logDiag('Map toggle error:', e); }
        try{ 
          if(on && window.L && !mapRendered){ 
            /* trigger size calc */ 
            setTimeout(()=>{ 
              try{ 
                window.dispatchEvent(new Event('resize')); 
                if(typeof map !== 'undefined' && map.invalidateSize) {
                  map.invalidateSize(); 
                }
              }catch(e){ logDiag('Map resize error:', e); }
            }, 100); 
          }
        }catch(e){ logDiag('Map resize error:', e); }
      });
    }
  }catch(e){ logDiag('Map toggle setup error:', e); }

  render(); renderTasks();

  // Compact final status (friendly line)
  if (PROJECTS.length === 0 && TASKS.length === 0 && SITES.length === 0) {
    statusEl.textContent = `No data loaded. Please enter your Azure DevOps Personal Access Token above to load data.`;
    statusEl.style.color = '#D97706';
  } else {
    statusEl.textContent = `Loaded Projects: ${PROJECTS.length} • Tasks: ${TASKS.length} • Sites: ${SITES.length}`;
  }
  logDiag('Data loaded counts', {projects:PROJECTS.length, tasks:TASKS.length, sites:SITES.length});
  hideLoader();



  // ===== Colorful map with robust coords (Leaflet) =====
  let mapRendered=false;
  let map = null;
  try{
    // Load Leaflet: try local SiteAssets first, then CDN
    async function ensureLeaflet(){
      if(window.L && typeof window.L.map==='function') return true;
      const base=_spPageContextInfo.webAbsoluteUrl.replace(/\/$/,'');
      // Prefer CDN CSS to avoid local MIME-type issues; local is optional
      const cssUrls=[
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
        base + '/SiteAssets/ot/leaflet.css',
        base + '/SiteAssets/leaflet.css'
      ];
      const jsUrls = IS_DEV
        ? [
            'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
          ]
        : [
            base + '/SiteAssets/ot/leaflet.js',
            base + '/SiteAssets/leaflet.js',
            'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
          ];
      function addCssOnce(url){
        try{
          if([...(document.styleSheets||[])].some(s=> s.href && s.href.indexOf('leaflet')!==-1)) return;
        }catch{}
        try{ const l=document.createElement('link'); l.rel='stylesheet'; l.href=url; document.head.appendChild(l); }catch{}
      }
      async function fetchText(u){
        try{
          const same = u.startsWith('/') || u.startsWith(base);
          const r = await fetch(u,{credentials: same?'same-origin':'omit'});
          if(!r.ok) return null;
          return await r.text();
        }catch{ return null }
      }
      function evalLeaflet(code){
        // Shadow AMD/CommonJS globals so Leaflet exports to window.L only
        const factory = new Function('window','document', 'var define, module, exports;\n' + code + '\n; return window.L;');
        try{ return factory(window, document); }catch{ return null }
      }
      // Add CSS first
      addCssOnce(cssUrls[0]);
      for(const url of jsUrls){
        const txt = await fetchText(url);
        if(!txt) continue;
        const Lns = evalLeaflet(txt);
        if(Lns && typeof Lns.map==='function'){ window.L = Lns; return true; }
      }
      // Fallback: try CDN last-resort again
      const cdn = await fetchText('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
      if(cdn){ const Lns = evalLeaflet(cdn); if(Lns && typeof Lns.map==='function'){ window.L = Lns; return true; } }
      return !!(window.L && typeof window.L.map==='function');
    }
    let leafletOk=false; try{ leafletOk = await ensureLeaflet(); }catch(e){ logDiag('ensureLeaflet threw', (e&&e.message)||String(e)); }
    logDiag('Leaflet load', {ok:leafletOk, hasL: !!window.L, version: window.L && window.L.version});
    // Ensure essential Leaflet CSS is present (fallback inline) so tiles/markers render under CSP
    try{
      const css = `.leaflet-container{position:relative;outline:0}.leaflet-pane,.leaflet-tile,.leaflet-marker-icon,.leaflet-marker-shadow,.leaflet-zoom-box,.leaflet-image-layer,.leaflet-layer{position:absolute;left:0;top:0}.leaflet-tile{width:256px;height:256px}.leaflet-pane{z-index:400}.leaflet-map-pane{z-index:200}.leaflet-tile-pane{z-index:200}.leaflet-overlay-pane{z-index:400}.leaflet-shadow-pane{z-index:500}.leaflet-marker-pane{z-index:600}.leaflet-tooltip-pane{z-index:650}.leaflet-popup-pane{z-index:700}.leaflet-zoom-animated{transform-origin:0 0}.leaflet-zoom-anim .leaflet-zoom-animated{will-change:transform}.leaflet-marker-icon,.leaflet-marker-shadow{display:block}.leaflet-container .leaflet-control-attribution{background:rgba(255,255,255,.8);margin:0;padding:0 4px;border-radius:4px}`;
      const st=document.createElement('style'); st.setAttribute('data-leaflet-inline','1'); st.textContent=css; document.head.appendChild(st);
      logDiag('Injected inline Leaflet CSS fallback (unconditional)');
    }catch{}
    if(!leafletOk){ 
      logDiag('Leaflet failed to load; using canvas fallback'); 
      // Create a simple fallback map display
      const mapEl = document.getElementById('map');
      if (mapEl) {
        mapEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:400px;background:#f8fafc;color:#64748b;border:1px solid #e2e8f0;border-radius:8px;"><div style="text-align:center;"><div style="font-size:24px;margin-bottom:8px;">🗺️</div><div>Map unavailable - Leaflet failed to load</div></div></div>';
        mapRendered = true;
      }
      return;
    }

    const mapEl = document.getElementById('map');
    if (!mapEl) {
      logDiag('Map container not found');
      return;
    }
    
    map=L.map('map',{
      zoomControl:true, 
      preferCanvas:true, 
      scrollWheelZoom:false,
      minZoom: 2,
      maxZoom: 18,
      worldCopyJump: true // Prevent tile repetition
    }).setView([20,0],2);
    try{ map.touchZoom.disable(); map.doubleClickZoom.disable(); }catch{}
    // Re-enable zoom on explicit user intent (Ctrl+wheel)
    try{
      const mapEl=document.getElementById('map');
      mapEl.addEventListener('wheel', function(e){ if(e.ctrlKey){ try{ map.scrollWheelZoom.enable(); }catch{} } else { try{ map.scrollWheelZoom.disable(); }catch{} } }, {passive:true});
    }catch{}
    // Default provider only: Esri Light Gray
    const providers=[
      {name:'EsriLightGray', url:'https://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', opts:{maxZoom:19, crossOrigin:true, attribution:'&copy; Esri', minZoom: 2, noWrap: false}}
    ];
    let baseLayer=null; let tilesOk=false;
    function useProvider(i){
      if(baseLayer){ map.removeLayer(baseLayer); baseLayer=null; }
      if(i>=providers.length) return false;
      const p=providers[i];
      baseLayer=L.tileLayer(p.url,{detectRetina:true, ...p.opts, noWrap: false}).addTo(map);
      let failed=false; baseLayer.on('tileerror',(ev)=>{ logDiag('tileerror', {provider:p.name, src:ev && ev.tile && ev.tile.src}); if(!failed){ failed=true; useProvider(i+1); } });
      baseLayer.on('load',()=>{ tilesOk=true; logDiag('tiles loaded', {provider:p.name}); try{ const pane=map.getPanes().overlayPane; if(pane&&pane.querySelectorAll){ pane.querySelectorAll('canvas[data-map-overlay="1"]').forEach(el=>{ try{ el.remove(); }catch{} }); } }catch{} });
      document.getElementById('mapNote').textContent = `Map: ${p.name}`;
      logDiag('Tile provider', {provider:p.name, url:p.url});
      return true;
    }
    useProvider(0);

    const pts=[];
    // Build project summaries per site for informative popups
    const bySite = PROJECTS.reduce((m,p)=>{
      const sc = (p.Site||'').toString().trim().toUpperCase();
      if(!sc) return m;
      if(!m[sc]) m[sc] = [];
      m[sc].push(p);
      return m;
    }, {});
    
    // Collect site coordinates (from both Projects and SITES)
    const siteCoordsMap = new Map(); // site -> {lat, lon}
    
    // Prefer precise coords from Projects; but collect all site coords
    PROJECTS.forEach(p=>{
      const {lat, lon} = fixLatLon(p.Latitude, p.Longitude);
      if(!isNaN(lat) && !isNaN(lon)){
        const site = (p.Site||'').toString().trim().toUpperCase();
        if(site){
          siteCoordsMap.set(site, {lat, lon});
          const type = p.ProjectType? `[${p.ProjectType}] `: '';
          const status = p.Status? ` (${p.Status})` : '';
          const label = `${site} — ${type}${p.Project||''}${status}`.trim();
          pts.push({site, lat, lon, label});
        }
      }
    });
    
    // Add SITES coordinates (even if we found some from Projects, to ensure all sites are shown)
    SITES.forEach(s=>{
      const siteCode = (s.Site||'').toString().trim().toUpperCase();
      if(!siteCode) return;
      
      // Only add if not already in map (from Projects)
      if(!siteCoordsMap.has(siteCode)){
        const {lat, lon} = fixLatLon(s.Latitude, s.Longitude);
        if(!isNaN(lat) && !isNaN(lon)){
          siteCoordsMap.set(siteCode, {lat, lon});
          const proj = bySite[siteCode]||[];
          const types = Array.from(new Set(proj.map(p=>p.ProjectType).filter(Boolean)));
          const top = types.length? ` — ${types.join(', ')}` : '';
          pts.push({site:siteCode, lat, lon, label:`${siteCode}${top}`});
        }
      }
    });
    
    // Skip marker rendering here - it happens in render() after data loads
    // This top-level code only initializes the map object
    if(false && pts.length){
      logDiag('Map points', {count:pts.length, sample:pts.slice(0,5)});
      const group=L.layerGroup(pts.map(pt=>{
        const m=L.circleMarker([pt.lat,pt.lon],{radius:7, weight:2, color:'#ffffff', fillColor:'#1A73E8', fillOpacity:0.95});
        const sc = (pt.site||'').toString().trim().toUpperCase();
        const projList = (bySite[sc]||[]);
        const details = projList.length? `<div style="margin-top:4px">`+projList.map(p=>{
          const t=p.ProjectType?`<b>[${p.ProjectType}]</b> `:'';
          const s=p.Status?` <span style="color:#6B7280">(${p.Status})</span>`:'';
          return `<div>${t}${p.Project||''}${s}</div>`;
        }).join('')+`</div>` : '';
        const html = `<div><b>${sc}</b>${details||''}</div>`;
        m.bindPopup(html);
        return m;
      })).addTo(map);
      try{ map.fitBounds(group.getBounds(),{padding:[24,24]}); }catch{}
      setTimeout(()=>{ try{ map.invalidateSize(); }catch{} },120);
      mapRendered=true;

      // If tiles don't load within 2s, draw a canvas overlay fallback on top of the map
      setTimeout(()=>{
        try{
          if(tilesOk) return;
          logDiag('Tile load timeout → enabling canvas overlay fallback');
          const pane = map.getPanes().overlayPane; const size = map.getSize(); if(!size||!size.x){ map.setView([20,0],2); }
          const cnv=document.createElement('canvas'); cnv.setAttribute('data-map-overlay','1'); cnv.width=size.x; cnv.height=size.y; cnv.style.position='absolute'; cnv.style.left='0'; cnv.style.top='0'; cnv.style.pointerEvents='none'; pane.appendChild(cnv);
          const ctx=cnv.getContext('2d');
      function redraw(){
            const s=map.getSize(); if(cnv.width!==s.x||cnv.height!==s.y){ cnv.width=s.x; cnv.height=s.y; }
            // background gradient (softer blue → purple)
            const g=ctx.createLinearGradient(0,0,0,cnv.height); g.addColorStop(0,'#dbeafe'); g.addColorStop(1,'#ede9fe'); ctx.fillStyle=g; ctx.fillRect(0,0,cnv.width,cnv.height);
            // draw points
            ctx.fillStyle='#1A73E8'; ctx.strokeStyle='#ffffff'; ctx.lineWidth=2;
            pts.forEach(pt=>{ const p=map.latLngToContainerPoint([pt.lat,pt.lon]); ctx.beginPath(); ctx.arc(p.x,p.y,6,0,Math.PI*2); ctx.fill(); ctx.stroke(); });
          }
          redraw();
          map.on('move zoom resize', ()=>{ try{ redraw(); }catch(e){ logDiag('overlay redraw error', (e&&e.message)||String(e)); } });
          const noteEl=document.getElementById('mapNote'); if(noteEl) noteEl.textContent = 'Map: overlay (no tiles)';
        }catch(e){ logDiag('overlay fallback error', (e&&e.message)||String(e)); }
      }, 2000);
    } else {
      logDiag('No points to render; falling back to default view');
      map.setView([20,0],2);
      mapRendered=true; // Mark as rendered even with no points
    }
  }catch(e){
    note('Leaflet fallback: '+e.message);
    logDiag('Leaflet exception', {error:e && (e.stack||e.message||String(e))});
  }

  // Canvas fallback (only if Leaflet failed)
  if(!mapRendered){
    try{
      const el=document.getElementById('map');
      const rect=el.getBoundingClientRect();
      const w=Math.max(600, Math.floor(rect.width));
      const h=420;
      const cnv=document.createElement('canvas'); cnv.width=w; cnv.height=h; cnv.style.width='100%'; cnv.style.height=h+'px';
      const ctx=cnv.getContext('2d');

      // Try local colorful image, else gradient
      async function tryLoadBasemap(){
        const base=_spPageContextInfo.webAbsoluteUrl.replace(/\/$/,'');
        const paths=[base + '/SiteAssets/ot/world_light_2048.png', base + '/SiteAssets/world_light_2048.png'];
        for(const p of paths){
          try{ await new Promise((res,rej)=>{ const img=new Image(); img.crossOrigin='anonymous'; img.onload=()=>{ ctx.drawImage(img,0,0,w,h); res(); }; img.onerror=rej; img.src=p; }); return true; }catch{}
        }
        return false;
      }
      let drew=await tryLoadBasemap();
      logDiag('Canvas fallback basemap', {imageLoaded:drew});
      if(!drew){ const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'#e0f2fe'); g.addColorStop(1,'#ffffff'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); }

      // Simple equirectangular plotter
      const xFromLon=lon=> (lon+180)/360*w; const yFromLat=lat=> (90-lat)/180*h;

      // Collect points as above
      const pts=[];
      PROJECTS.forEach(p=>{ const {lat,lon}=fixLatLon(p.Latitude,p.Longitude); if(!isNaN(lat)&&!isNaN(lon)) pts.push({lat,lon,label:(p.Site||'')}); });
      if(!pts.length){ SITES.forEach(s=>{ const {lat,lon}=fixLatLon(s.Latitude,s.Longitude); if(!isNaN(lat)&&!isNaN(lon)) pts.push({lat,lon,label:(s.Site||'')}); }); }

      ctx.fillStyle='#2563EB'; ctx.strokeStyle='#1D4ED8';
      pts.forEach(pt=>{ const x=xFromLon(pt.lon), y=yFromLat(pt.lat); ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill(); ctx.stroke(); });
      logDiag('Canvas points plotted', {count:pts.length});

      el.innerHTML=''; el.appendChild(cnv);
      document.getElementById('mapNote').textContent = 'Map: fallback (static - world image or graticule)';
      logDiag('Map mode', 'fallback-static');
    }catch{}
  }

})();
</script>

</body>
</html>
